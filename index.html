<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dune Imperium Blend Builder</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="static/app.js?v=2"></script>
    <!-- GoatCounter analytics - only active on GitHub Pages -->
    <script>
        if (window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1' && !window.location.hostname.startsWith('192.168.')) {
            var script = document.createElement('script');
            script.async = true;
            script.src = '//gc.zgo.at/count.js';
            script.setAttribute('data-goatcounter', 'https://anttttti.goatcounter.com/count');
            document.head.appendChild(script);
        }
    </script>
    <style>
        :root {
            --dune-sand: #E8D5B7;
            --dune-sand-dark: #C9A86C;
            --dune-brown: #8B6914;
            --dune-spice: #D2691E;
            --dune-dark: #2C1810;
        }

        body {
            padding: 0;
            background: linear-gradient(135deg, #f5f0e6 0%, #e8dcc8 50%, #d9c9a8 100%);
            min-height: 100vh;
        }

        /* Header styling */
        .app-header {
            background: linear-gradient(135deg, var(--dune-dark) 0%, #4a3520 100%);
            padding: 1rem 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            border-bottom: 3px solid var(--dune-spice);
        }

        .app-header h1 {
            color: var(--dune-sand);
            font-weight: 300;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        /* Main container */
        .main-container {
            padding: 0 20px 20px 20px;
        }

        /* Controls bar */
        .controls-bar {
            background: rgba(255,255,255,0.85);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid rgba(139,105,20,0.2);
        }

        .controls-bar .form-label {
            font-weight: 500;
            color: var(--dune-dark);
        }

        .controls-bar .btn-primary {
            background: linear-gradient(135deg, var(--dune-brown) 0%, #6b5210 100%);
            border: none;
        }
        .controls-bar .btn-primary:hover {
            background: linear-gradient(135deg, #a67c1a 0%, var(--dune-brown) 100%);
        }

        .controls-bar .btn-success {
            background: linear-gradient(135deg, #4a7c3f 0%, #366b2c 100%);
            border: none;
        }

        .controls-bar .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            border: none;
        }

        /* Overview textarea auto-resize */
        #overview-description,
        #overview-leader-selection,
        #overview-house-rules {
            overflow-y: hidden;
            resize: vertical;
            line-height: 1.5;
        }

        /* Tab styling */
        .nav-tabs {
            margin-bottom: 20px;
            border-bottom: 2px solid var(--dune-sand-dark);
            flex-wrap: wrap;
            background: rgba(255,255,255,0.6);
            padding: 0.5rem 0.5rem 0;
            border-radius: 8px 8px 0 0;
        }
        .nav-tabs .nav-link {
            color: var(--dune-dark);
            border: none;
            padding: 8px 15px;
            font-size: 0.9em;
            border-radius: 4px 4px 0 0;
            transition: all 0.2s ease;
        }
        .nav-tabs .nav-link.active {
            color: #fff;
            background: linear-gradient(135deg, var(--dune-brown) 0%, #6b5210 100%);
            border-bottom: 3px solid var(--dune-spice);
            font-weight: bold;
        }
        .nav-tabs .nav-link:hover:not(.active) {
            background-color: rgba(139,105,20,0.15);
        }
        .nav-tabs .nav-link .badge {
            font-size: 0.75em;
        }
        .nav-tabs .nav-link.active .badge {
            background-color: var(--dune-spice) !important;
        }

        /* Tab content panels */
        .tab-content {
            background: rgba(255,255,255,0.9);
            border-radius: 0 0 8px 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid rgba(139,105,20,0.15);
            border-top: none;
        }

        .tab-pane h4, .tab-pane h5 {
            color: var(--dune-dark);
        }

        /* Expansion colors - light backgrounds with dark text */
        .expansion-base { background-color: #F5DEB3 !important; color: #000 !important; }
        .expansion-ix { background-color: #B0E0E6 !important; color: #000 !important; }
        .expansion-immortality { background-color: #E2EFDA !important; color: #000 !important; }
        .expansion-uprising { background-color: #DEB887 !important; color: #000 !important; }
        .expansion-bloodlines { background-color: #FF6B6B !important; color: #000 !important; }
        .expansion-promo { background-color: #E0CFFC !important; color: #000 !important; }

        td.expansion-base { background-color: #F5DEB3 !important; color: #000 !important; }
        td.expansion-ix { background-color: #B0E0E6 !important; color: #000 !important; }
        td.expansion-immortality { background-color: #E2EFDA !important; color: #000 !important; }
        td.expansion-uprising { background-color: #DEB887 !important; color: #000 !important; }
        td.expansion-bloodlines { background-color: #FF6B6B !important; color: #000 !important; }
        td.expansion-promo { background-color: #E0CFFC !important; color: #000 !important; }

        /* Table styling */
        .table-sm td, .table-sm th {
            padding: 0.4rem;
            vertical-align: middle;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .resource-row { cursor: pointer; user-select: none; }
        .resource-row:hover { background-color: #f8f9fa !important; }

        /* Multi-selection highlighting */
        .resource-row.multi-selected {
            outline: 2px solid var(--dune-spice) !important;
            outline-offset: -2px;
        }

        .resource-row.multi-selected td {
            filter: brightness(0.92);
        }

        /* Highlight rows with selected items - no background color to preserve expansion colors */
        .resource-row.has-selection {
            font-weight: 600;
        }

        .resource-row.has-selection td:first-child {
            border-left: 4px solid #007acc;
        }

        .sticky-top { position: sticky; top: 0; z-index: 10; }

        .selected-list { max-height: 250px; overflow-y: auto; }

        /* Access column colors */
        .access-x {
            text-align: center;
            font-weight: bold;
            color: #0066cc;
            width: 40px !important;
            max-width: 40px !important;
            min-width: 40px !important;
            padding: 4px 2px !important;
            overflow: hidden;
        }

        .access-green { background-color: #90EE90 !important; color: #000 !important; }
        .access-purple { background-color: #DDA0DD !important; color: #000 !important; }
        .access-yellow { background-color: #FFFF99 !important; color: #000 !important; }
        .access-emperor { background-color: #C0C0C0 !important; color: #000 !important; }
        .access-guild { background-color: #FFB6B6 !important; color: #000 !important; }
        .access-bg { background-color: #E6D5E6 !important; color: #000 !important; }
        .access-fremen { background-color: #ADD8E6 !important; color: #000 !important; }
        .access-spy { background-color: #D3D3D3 !important; color: #000 !important; }

        /* Affiliation column styling - similar to access but with different sizing */
        .affiliation-x {
            text-align: center;
            font-weight: bold;
            color: #0066cc;
            padding: 4px 2px !important;
            overflow: hidden;
        }

        /* Compact columns for numeric/short values */
        td.compact {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            padding: 4px 8px;
        }

        /* Make table cells truncate with ellipsis for long content */
        .table-hover td {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .table-hover td[title] {
            cursor: help;
        }

        /* Column resizing */
        th.resizable {
            position: relative;
            padding-right: 10px !important;
        }
        .resize-handle {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 8px;
            cursor: col-resize;
            user-select: none;
            background: transparent;
            z-index: 10;
        }
        .resize-handle:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }

        /* Ensure table respects column widths */
        table[style*="table-layout: fixed"] th,
        table[style*="table-layout: fixed"] td {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .group-header {
            text-align: center;
            background-color: #6c757d !important;
            color: white !important;
            font-weight: bold;
        }

        /* Statistics bar charts */
        .stat-bar-container {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        /* Reduce spacing in statistics sections */
        #imperium-stats p, #intrigue-stats p, #tleilax-stats p, #reserve-stats p,
        #tech-stats p, #contracts-stats p, #leader-stats p, #conflict-stats p,
        #starter-stats p, #sardaukar-stats p {
            margin-bottom: 4px;
            margin-top: 8px;
        }

        #imperium-stats p:first-child, #intrigue-stats p:first-child, #tleilax-stats p:first-child,
        #reserve-stats p:first-child, #tech-stats p:first-child, #contracts-stats p:first-child,
        #leader-stats p:first-child, #conflict-stats p:first-child, #starter-stats p:first-child,
        #sardaukar-stats p:first-child {
            margin-top: 0;
        }

        .stat-bar-label {
            min-width: 120px;
            font-size: 0.9em;
        }

        .stat-bar-wrapper {
            flex: 1;
            background-color: #f8f9fa;
            border-radius: 3px;
            height: 20px;
            position: relative;
            overflow: hidden;
        }

        .stat-bar {
            height: 100%;
            background: linear-gradient(90deg, rgba(77, 148, 255, 1), rgba(128, 179, 255, 0.6));
            border-radius: 3px;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 6px;
            min-width: 20px;
        }

        .stat-bar-value {
            font-size: 0.85em;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .stat-bar-percentage {
            font-size: 0.9em;
            color: #000;
            min-width: 50px;
            text-align: right;
        }

        /* Sortable columns */
        .sortable {
            cursor: pointer !important;
            user-select: none;
        }
        .sortable:hover {
            background-color: #e9ecef !important;
        }

        /* Modal dialog theming */
        .modal-content {
            border: none;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, var(--dune-dark) 0%, #4a3520 100%);
            color: var(--dune-sand);
            border-bottom: 3px solid var(--dune-spice);
            border-radius: 8px 8px 0 0;
        }

        .modal-header .modal-title {
            color: var(--dune-sand);
            font-weight: 400;
            letter-spacing: 1px;
        }

        .modal-header .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        .modal-footer {
            background-color: #f8f5f0;
            border-top: 1px solid var(--dune-sand-dark);
        }

        .modal-body {
            background-color: #fdfcfa;
        }

        /* Blend sections in load dialog */
        .blend-section {
            border-left-color: var(--dune-brown) !important;
        }

        .blend-section h6 {
            color: var(--dune-dark);
        }

        /* Remote blends section */
        #loadBlendModal .blend-section:first-of-type {
            background: linear-gradient(135deg, #f5ebe0 0%, #ede4d8 100%) !important;
            border-left-color: var(--dune-brown) !important;
        }

        /* Local file section */
        #loadBlendModal .blend-section:last-of-type {
            background: linear-gradient(135deg, #e8dcc8 0%, #ddd0bc 100%) !important;
            border-left-color: var(--dune-spice) !important;
        }

        #dropZone {
            background-color: #fdfcfa !important;
            border-color: var(--dune-sand-dark) !important;
            transition: all 0.2s ease;
        }

        #dropZone:hover {
            background-color: #f5ebe0 !important;
            border-color: var(--dune-brown) !important;
        }

        /* Modal buttons */
        .modal-body .btn-primary {
            background: linear-gradient(135deg, var(--dune-brown) 0%, #6b5210 100%);
            border: none;
        }

        .modal-body .btn-primary:hover {
            background: linear-gradient(135deg, #a67c1a 0%, var(--dune-brown) 100%);
        }

        .modal-body .btn-success {
            background: linear-gradient(135deg, #4a7c3f 0%, #366b2c 100%);
            border: none;
        }

        .modal-footer .btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
            border: none;
        }

        /* List group items in modals */
        .modal .list-group-item {
            border-color: rgba(139,105,20,0.2);
        }

        .modal .list-group-item:hover {
            background-color: #f5ebe0;
        }

        .modal .list-group-item.active {
            background: linear-gradient(135deg, var(--dune-brown) 0%, #6b5210 100%);
            border-color: var(--dune-brown);
        }
    </style>
</head>
<body>
    <!-- App Header -->
    <header class="app-header">
        <h1>Dune Imperium Blend Builder</h1>
    </header>

    <div class="container-fluid main-container">
        <!-- Controls Bar -->
        <div class="controls-bar">
            <div class="row align-items-end">
                <div class="col-md-6">
                    <label for="blendName" class="form-label">Filename:</label>
                    <input type="text" class="form-control" id="blendName" value="My_Custom_Blend.md">
                </div>
                <div class="col-md-6 text-end mt-2 mt-md-0">
                    <button class="btn btn-primary btn-sm me-2" onclick="showSaveAsDialog()">Save</button>
                    <button class="btn btn-success btn-sm me-2" onclick="showLoadDialog()">Load</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearBlend()">Clear All</button>
                </div>
            </div>
        </div>

        <!-- Resource Type Tabs -->
        <ul class="nav nav-tabs" id="resourceTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="board-tab" data-bs-toggle="tab" data-bs-target="#board-panel" type="button" onclick="updateRequiredSets()">
                    Board
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview-panel" type="button" onclick="setTimeout(initOverviewTextareas, 50)">
                    Overview
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="imperium-tab" data-bs-toggle="tab" data-bs-target="#imperium-panel" type="button">
                    Imperium <span id="imperium-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="intrigue-tab" data-bs-toggle="tab" data-bs-target="#intrigue-panel" type="button">
                    Intrigue <span id="intrigue-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tleilax-tab" data-bs-toggle="tab" data-bs-target="#tleilax-panel" type="button">
                    Tleilax <span id="tleilax-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reserve-tab" data-bs-toggle="tab" data-bs-target="#reserve-panel" type="button">
                    Reserve <span id="reserve-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tech-tab" data-bs-toggle="tab" data-bs-target="#tech-panel" type="button">
                    Tech <span id="tech-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="contracts-tab" data-bs-toggle="tab" data-bs-target="#contracts-panel" type="button">
                    Contracts <span id="contracts-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="leader-tab" data-bs-toggle="tab" data-bs-target="#leader-panel" type="button">
                    Leaders <span id="leader-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sardaukar-tab" data-bs-toggle="tab" data-bs-target="#sardaukar-panel" type="button">
                    Sardaukar <span id="sardaukar-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="starter-tab" data-bs-toggle="tab" data-bs-target="#starter-panel" type="button">
                    Starter <span id="starter-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="conflict-tab" data-bs-toggle="tab" data-bs-target="#conflict-panel" type="button">
                    Conflict <span id="conflict-badge" class="badge bg-secondary">0</span>
                </button>
            </li>
        </ul>

        <!-- Tab Content Panels -->
        <div class="tab-content" id="resourceTabContent">
            <!-- Board Panel -->
            <div class="tab-pane fade show active" id="board-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4>Board Selection</h4>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>Main Game Boards (Choose One)</h5>
                            </div>
                            <div class="card-body">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="mainBoard" id="board-imperium" value="imperium" checked onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-imperium">
                                        <strong>1. Dune: Imperium Board</strong>
                                        <p class="text-muted mb-0">Features the Mentat token mechanic and Foldspace cards</p>
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="mainBoard" id="board-uprising" value="uprising" onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-uprising">
                                        <strong>2. Dune: Imperium - Uprising Board</strong>
                                        <p class="text-muted mb-0">Features spies, sandworms, and observation posts</p>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5>Additional Boards & Overlays by Expansion</h5>
                            </div>
                            <div class="card-body">
                                <h6 class="mt-3"><strong>Rise of Ix:</strong></h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="board-choam" value="choam" onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-choam">
                                        <strong>CHOAM Board Overlay</strong> - sits on top of and expands the original game's CHOAM area, replacing the spice-to-Solari conversion with an Interstellar Shipping track
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="board-ix" value="ix" onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-ix">
                                        <strong>Ix Board</strong> - sits alongside the upper right side of the main board, featuring spaces for 18 Tech tiles organized in three stacks
                                    </label>
                                </div>

                                <h6 class="mt-3"><strong>Immortality:</strong></h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="board-tleilax" value="tleilax" onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-tleilax">
                                        <strong>Bene Tleilax Board</strong> - features two tracks: a research track (triggered by microscope icons) and a Tleilaxu track for genetic specimens
                                    </label>
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="board-research" value="research" onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-research">
                                        <strong>Research Station Overlay</strong>
                                    </label>
                                </div>

                                <h6 class="mt-3"><strong>Bloodlines:</strong></h6>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="board-embassy" value="embassy" onchange="updateRequiredSets()">
                                    <label class="form-check-label" for="board-embassy">
                                        <strong>Ixian Embassy Board</strong> - kept to the side of the main board, offering three stacks of Tech tiles available for purchase when sending agents to any Landsraad (green) space
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card mt-3">
                            <div class="card-header">
                                <h5>ðŸ“¦ Required Sets <small class="text-muted ms-2">(auto-detected from selections)</small></h5>
                            </div>
                            <div class="card-body">
                                <div id="requiredSetsContainer">
                                    <span class="text-muted">No sets selected yet</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Overview Panel -->
            <div class="tab-pane fade" id="overview-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4>Overview</h4>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>Description</h5>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="overview-description" rows="6" placeholder=""></textarea>
                            </div>
                        </div>

                        <div class="card mb-3">
                            <div class="card-header">
                                <h5>Leader Selection</h5>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="overview-leader-selection" rows="4" placeholder=""></textarea>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5>House Rules</h5>
                            </div>
                            <div class="card-body">
                                <textarea class="form-control" id="overview-house-rules" rows="8" placeholder=""></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Imperium Panel -->
            <div class="tab-pane fade" id="imperium-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Available Imperium Cards <span class="badge bg-secondary" id="imperium-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('imperium')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" id="imperium-table" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 100px;"><!-- Name -->
                                    <col style="width: 50px;"><!-- Set -->
                                    <col style="width: 45px;"><!-- Count -->
                                    <col style="width: 35px;"><!-- Cost -->
                                    <col style="width: 70px;"><!-- Agent -->
                                    <col style="width: 70px;"><!-- Passive -->
                                    <col style="width: 80px;"><!-- Acquisition -->
                                    <col style="width: 45px;"><!-- Reveal Persuasion -->
                                    <col style="width: 45px;"><!-- Reveal Swords -->
                                    <col style="width: 70px;"><!-- Reveal Ability -->
                                    <col style="width: 35px;"><!-- Tech -->
                                    <col style="width: 40px;"><!-- Shipping -->
                                    <col style="width: 40px;"><!-- Unload -->
                                    <col style="width: 50px;"><!-- Infiltration -->
                                    <col style="width: 45px;"><!-- Research -->
                                    <col style="width: 40px;"><!-- Grafting -->
                                    <col style="width: 35px;"><!-- Spies -->
                                    <col style="width: 50px;"><!-- Sandworms -->
                                    <col style="width: 50px;"><!-- Contracts -->
                                    <col style="width: 50px;"><!-- Sardaukar -->
                                    <col style="width: 35px;"><!-- Green Access -->
                                    <col style="width: 35px;"><!-- Purple Access -->
                                    <col style="width: 35px;"><!-- Yellow Access -->
                                    <col style="width: 45px;"><!-- Emperor Access -->
                                    <col style="width: 35px;"><!-- Spacing Guild Access -->
                                    <col style="width: 70px;"><!-- Bene Gesserit Access -->
                                    <col style="width: 40px;"><!-- Fremen Access -->
                                    <col style="width: 30px;"><!-- Spy Access -->
                                    <col style="width: 45px;"><!-- Emperor Affiliation -->
                                    <col style="width: 45px;"><!-- Spacing Guild Affiliation -->
                                    <col style="width: 70px;"><!-- Bene Gesserit Affiliation -->
                                    <col style="width: 45px;"><!-- Fremen Affiliation -->
                                    <col style="width: 50px;"><!-- Compatibility -->
                                    <col style="width: 35px;"><!-- VPs -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="cursor: pointer;" onclick="sortResourceTable('imperium', 'selected')">
                                            Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('imperium');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('imperium');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div>
                                        </th>
                                        <th rowspan="2" class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('imperium', 'name')">
                                            Name<div class="resize-handle"></div>
                                        </th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('imperium', 'source')">
                                            Set<div class="resize-handle"></div>
                                        </th>
                                        <th rowspan="2" class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('imperium', 'count')">
                                            Count<div class="resize-handle"></div>
                                        </th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'persuasion_cost')">
                                            Cost<div class="resize-handle"></div>
                                        </th>
                                        <th colspan="3" class="group-header">Abilities</th>
                                        <th colspan="3" class="group-header">Reveal</th>
                                        <th colspan="10" class="group-header">Mechanics</th>
                                        <th colspan="8" class="group-header">Access</th>
                                        <th colspan="4" class="group-header">Affiliation</th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('imperium', 'compatibility')">
                                            Compat<div class="resize-handle"></div>
                                        </th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'vps_available')">
                                            VPs<div class="resize-handle"></div>
                                        </th>
                                    </tr>
                                    <tr>
                                        <!-- Ability columns -->
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'agent_ability')">
                                            Agent<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 55px; cursor: pointer;" onclick="sortResourceTable('imperium', 'passive_ability')">
                                            Passive<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('imperium', 'acquisition_bonus')">
                                            Acquisition<div class="resize-handle"></div>
                                        </th>
                                        <!-- Reveal columns -->
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('imperium', 'reveal_persuasion')">
                                            Persuasion<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('imperium', 'reveal_swords')">
                                            Swords<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'reveal_ability')">
                                            Ability<div class="resize-handle"></div>
                                        </th>
                                        <!-- Mechanics columns -->
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'tech')">
                                            Tech<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'shipping')">
                                            Shipping<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'unload')">
                                            Unload<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('imperium', 'infiltration')">
                                            Infiltration<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'research')">
                                            Research<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'grafting')">
                                            Grafting<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'spies')">
                                            Spies<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('imperium', 'sandworms')">
                                            Sandworms<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('imperium', 'contracts')">
                                            Contracts<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('imperium', 'sardaukar')">
                                            Sardaukar<div class="resize-handle"></div>
                                        </th>
                                        <!-- Access columns -->
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'green_access')">
                                            Green<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'purple_access')">
                                            Purple<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'yellow_access')">
                                            Yellow<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'emperor_access')">
                                            Emperor<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'spacing_guild_access')">
                                            Spacing Guild<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'bene_gesserit_access')">
                                            Bene Gesserit<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'fremen_access')">
                                            Fremen<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('imperium', 'spy_access')">
                                            Spy<div class="resize-handle"></div>
                                        </th>
                                        <!-- Affiliation columns -->
                                        <th class="resizable sortable" style="width: 55px; cursor: pointer;" onclick="sortResourceTable('imperium', 'emperor_affiliation')">
                                            Emperor<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 55px; cursor: pointer;" onclick="sortResourceTable('imperium', 'spacing_guild_affiliation')">
                                            Spacing Guild<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 55px; cursor: pointer;" onclick="sortResourceTable('imperium', 'bene_gesserit_affiliation')">
                                            Bene Gesserit<div class="resize-handle"></div>
                                        </th>
                                        <th class="resizable sortable" style="width: 55px; cursor: pointer;" onclick="sortResourceTable('imperium', 'fremen_affiliation')">
                                            Fremen<div class="resize-handle"></div>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="imperium-tbody"></tbody>
                            </table>
                        </div>
                        <div class="table-resize-handle" data-table="imperium-table-container"></div>
                        <small class="text-muted">Use +/- buttons to add/remove cards from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="imperium-stats">
                            <p class="text-muted">No cards selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Intrigue Panel -->
            <div class="tab-pane fade" id="intrigue-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Intrigue Cards <span class="badge bg-secondary" id="intrigue-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('intrigue')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 100px;"><!-- Name -->
                                    <col style="width: 50px;"><!-- Set -->
                                    <col style="width: 45px;"><!-- Count -->
                                    <col style="width: 30px;"><!-- Tech -->
                                    <col style="width: 40px;"><!-- Shipping -->
                                    <col style="width: 45px;"><!-- Research -->
                                    <col style="width: 35px;"><!-- Spies -->
                                    <col style="width: 50px;"><!-- Sandworms -->
                                    <col style="width: 50px;"><!-- Contracts -->
                                    <col style="width: 50px;"><!-- Sardaukar -->
                                    <col style="width: 70px;"><!-- Plot -->
                                    <col style="width: 70px;"><!-- Combat -->
                                    <col style="width: 70px;"><!-- Endgame -->
                                    <col style="width: 30px;"><!-- VPs -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('intrigue');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('intrigue');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'name')">Name<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'source')">Set<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'count')">Count<div class="resize-handle"></div></th>
                                        <th colspan="7" class="group-header">Mechanics</th>
                                        <th colspan="3" class="group-header">Effects</th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'vps_available')">VPs<div class="resize-handle"></div></th>
                                    </tr>
                                    <tr>
                                        <!-- Mechanics -->
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'tech')">Tech<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'shipping')">Shipping<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'research')">Research<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'spies')">Spies<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'sandworms')">Sandworms<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'contracts')">Contracts<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'sardaukar')">Sardaukar<div class="resize-handle"></div></th>
                                        <!-- Effects -->
                                        <th class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'plot_effect')">Plot<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'combat_effect')">Combat<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('intrigue', 'endgame_effect')">Endgame<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="intrigue-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove cards from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="intrigue-stats">
                            <p class="text-muted">No cards selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tleilax Panel -->
            <div class="tab-pane fade" id="tleilax-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Tleilax Cards <span class="badge bg-secondary" id="tleilax-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('tleilax')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 100px;"><!-- Name -->
                                    <col style="width: 50px;"><!-- Set -->
                                    <col style="width: 45px;"><!-- Count -->
                                    <col style="width: 35px;"><!-- Cost -->
                                    <col style="width: 70px;"><!-- Agent -->
                                    <col style="width: 45px;"><!-- Reveal Persuasion -->
                                    <col style="width: 45px;"><!-- Reveal Swords -->
                                    <col style="width: 70px;"><!-- Reveal Ability -->
                                    <col style="width: 50px;"><!-- Infiltration -->
                                    <col style="width: 45px;"><!-- Research -->
                                    <col style="width: 40px;"><!-- Grafting -->
                                    <col style="width: 35px;"><!-- Green Access -->
                                    <col style="width: 35px;"><!-- Purple Access -->
                                    <col style="width: 35px;"><!-- Yellow Access -->
                                    <col style="width: 45px;"><!-- Emperor Access -->
                                    <col style="width: 35px;"><!-- Spacing Guild Access -->
                                    <col style="width: 30px;"><!-- BG Access -->
                                    <col style="width: 40px;"><!-- Fremen Access -->
                                    <col style="width: 30px;"><!-- VPs -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('tleilax');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('tleilax');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'name')">Name<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'source')">Set<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'count')">Count<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'specimen_cost')">Cost<div class="resize-handle"></div></th>
                                        <th colspan="1" class="group-header">Abilities</th>
                                        <th colspan="3" class="group-header">Reveal</th>
                                        <th colspan="3" class="group-header">Mechanics</th>
                                        <th colspan="7" class="group-header">Access</th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'vps_available')">VPs<div class="resize-handle"></div></th>
                                    </tr>
                                    <tr>
                                        <!-- Abilities -->
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'agent_ability')">Agent<div class="resize-handle"></div></th>
                                        <!-- Reveal -->
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'reveal_persuasion')">Persuasion<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'reveal_swords')">Swords<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'reveal_ability')">Ability<div class="resize-handle"></div></th>
                                        <!-- Mechanics -->
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'infiltration')">Infiltration<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'research')">Research<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'grafting')">Grafting<div class="resize-handle"></div></th>
                                        <!-- Access -->
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'green_access')">Green<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'purple_access')">Purple<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'yellow_access')">Yellow<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'emperor_access')">Emperor<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'spacing_guild_access')">Spacing Guild<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 40px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'bene_gesserit_access')">BG<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('tleilax', 'fremen_access')">Fremen<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="tleilax-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove cards from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="tleilax-stats">
                            <p class="text-muted">No cards selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Reserve Panel -->
            <div class="tab-pane fade" id="reserve-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Reserve Cards <span class="badge bg-secondary" id="reserve-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('reserve')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 100px;"><!-- Name -->
                                    <col style="width: 50px;"><!-- Set -->
                                    <col style="width: 45px;"><!-- Count -->
                                    <col style="width: 35px;"><!-- Cost -->
                                    <col style="width: 70px;"><!-- Agent -->
                                    <col style="width: 70px;"><!-- Passive -->
                                    <col style="width: 45px;"><!-- Persuasion -->
                                    <col style="width: 45px;"><!-- Swords -->
                                    <col style="width: 70px;"><!-- Ability -->
                                    <col style="width: 35px;"><!-- Green -->
                                    <col style="width: 35px;"><!-- Purple -->
                                    <col style="width: 35px;"><!-- Yellow -->
                                    <col style="width: 45px;"><!-- Emperor -->
                                    <col style="width: 35px;"><!-- Spacing Guild -->
                                    <col style="width: 30px;"><!-- BG -->
                                    <col style="width: 40px;"><!-- Fremen -->
                                    <col style="width: 30px;"><!-- Spy -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('reserve', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('reserve');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('reserve');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('reserve', 'name')">Name<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('reserve', 'source')">Set<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('reserve', 'count')">Count<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('reserve', 'persuasion_cost')">Cost<div class="resize-handle"></div></th>
                                        <th colspan="2" class="group-header">Abilities</th>
                                        <th colspan="3" class="group-header">Reveal</th>
                                        <th colspan="8" class="group-header">Access</th>
                                    </tr>
                                    <tr>
                                        <!-- Abilities -->
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('reserve', 'agent_ability')">Agent<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 55px; cursor: pointer;" onclick="sortResourceTable('reserve', 'passive')">Passive<div class="resize-handle"></div></th>
                                        <!-- Reveal -->
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('reserve', 'reveal_persuasion')">Persuasion<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('reserve', 'reveal_swords')">Swords<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('reserve', 'reveal_ability')">Ability<div class="resize-handle"></div></th>
                                        <!-- Access -->
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('reserve', 'green_access')">Green<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('reserve', 'purple_access')">Purple<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('reserve', 'yellow_access')">Yellow<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('reserve', 'emperor_access')">Emperor<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('reserve', 'spacing_guild_access')">Spacing Guild<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 40px; cursor: pointer;" onclick="sortResourceTable('reserve', 'bene_gesserit_access')">BG<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('reserve', 'fremen_access')">Fremen<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 40px; cursor: pointer;" onclick="sortResourceTable('reserve', 'spy_access')">Spy<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="reserve-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove cards from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="reserve-stats">
                            <p class="text-muted">No cards selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tech Panel -->
            <div class="tab-pane fade" id="tech-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Tech Tiles <span class="badge bg-secondary" id="tech-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('tech')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 100px;"><!-- Name -->
                                    <col style="width: 50px;"><!-- Set -->
                                    <col style="width: 50px;"><!-- Compat -->
                                    <col style="width: 35px;"><!-- Cost -->
                                    <col style="width: 40px;"><!-- Shipping -->
                                    <col style="width: 35px;"><!-- Spies -->
                                    <col style="width: 50px;"><!-- Sandworms -->
                                    <col style="width: 50px;"><!-- Contracts -->
                                    <col style="width: 50px;"><!-- Sardaukar -->
                                    <col style="width: 30px;"><!-- VPs -->
                                    <col style="width: 100px;"><!-- Effect -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('tech', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('tech');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('tech');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('tech', 'name')">Name<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('tech', 'source')">Set<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('tech', 'compatibility')">Compat<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tech', 'spice_cost')">Cost<div class="resize-handle"></div></th>
                                        <th colspan="5" class="group-header">Mechanics</th>
                                        <th rowspan="2" class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tech', 'vps_available')">VPs<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('tech', 'effect')">Effect<div class="resize-handle"></div></th>
                                    </tr>
                                    <tr>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('tech', 'shipping')">Shipping<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('tech', 'spies')">Spies<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('tech', 'sandworms')">Sandworms<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('tech', 'contracts')">Contracts<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('tech', 'sardaukar')">Sardaukar<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="tech-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove tech from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="tech-stats">
                            <p class="text-muted">No tech selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contracts Panel -->
            <div class="tab-pane fade" id="contracts-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Contracts <span class="badge bg-secondary" id="contracts-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('contracts')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 200px;"><!-- Name -->
                                    <col style="width: 80px;"><!-- Set -->
                                    <col style="width: 70px;"><!-- Count -->
                                    <col style="width: 150px;"><!-- Reward -->
                                    <col style="width: 80px;"><!-- Ix Specific -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('contracts', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('contracts');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('contracts');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 200px; cursor: pointer;" onclick="sortResourceTable('contracts', 'name')">Name<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('contracts', 'source')">Set<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('contracts', 'count')">Count<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('contracts', 'reward')">Reward<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('contracts', 'rise_of_ix__specific')">Ix Specific<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="contracts-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove contracts from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="contracts-stats">
                            <p class="text-muted">No contracts selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leader Panel -->
            <div class="tab-pane fade" id="leader-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Leaders <span class="badge bg-secondary" id="leader-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('leader')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 150px;"><!-- Name -->
                                    <col style="width: 80px;"><!-- Set -->
                                    <col style="width: 80px;"><!-- Compat -->
                                    <col style="width: 100px;"><!-- House -->
                                    <col style="width: 150px;"><!-- Starting Effect -->
                                    <col style="width: 150px;"><!-- Leader Ability -->
                                    <col style="width: 150px;"><!-- Signet Ring -->
                                    <col style="width: 80px;"><!-- Complexity -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('leader', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('leader');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('leader');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('leader', 'name')">Name<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('leader', 'source')">Set<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('leader', 'compatibility')">Compat<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('leader', 'house')">House<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('leader', 'starting_effect')">Starting Effect<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('leader', 'leader_ability')">Leader Ability<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('leader', 'signet_ring_ability')">Signet Ring<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('leader', 'listed_complexity_level')">Complexity<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="leader-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove leaders from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="leader-stats">
                            <p class="text-muted">No leaders selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sardaukar Panel -->
            <div class="tab-pane fade" id="sardaukar-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Sardaukar <span class="badge bg-secondary" id="sardaukar-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('sardaukar')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 150px;"><!-- Name -->
                                    <col style="width: 80px;"><!-- Set -->
                                    <col style="width: 100px;"><!-- Compatibility -->
                                    <col style="width: 60px;"><!-- Count -->
                                    <col style="width: 250px;"><!-- Effect -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('sardaukar', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('sardaukar');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('sardaukar');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('sardaukar', 'name')">Name</th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('sardaukar', 'source')">Set</th>
                                        <th class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('sardaukar', 'compatibility')">Compatibility</th>
                                        <th class="resizable sortable" style="width: 60px; cursor: pointer;" onclick="sortResourceTable('sardaukar', 'count')">Count</th>
                                        <th class="resizable sortable" style="width: 250px; cursor: pointer;" onclick="sortResourceTable('sardaukar', 'effect')">Effect</th>
                                    </tr>
                                </thead>
                                <tbody id="sardaukar-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove sardaukar from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="sardaukar-stats">
                            <p class="text-muted">No sardaukar selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Starter Panel -->
            <div class="tab-pane fade" id="starter-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Starter Cards <span class="badge bg-secondary" id="starter-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('starter')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 100px;"><!-- Name -->
                                    <col style="width: 50px;"><!-- Set -->
                                    <col style="width: 50px;"><!-- Compat -->
                                    <col style="width: 45px;"><!-- Count/Player -->
                                    <col style="width: 35px;"><!-- Green -->
                                    <col style="width: 35px;"><!-- Purple -->
                                    <col style="width: 35px;"><!-- Yellow -->
                                    <col style="width: 45px;"><!-- Emperor -->
                                    <col style="width: 35px;"><!-- Spacing Guild -->
                                    <col style="width: 30px;"><!-- BG -->
                                    <col style="width: 40px;"><!-- Fremen -->
                                    <col style="width: 45px;"><!-- Persuasion -->
                                    <col style="width: 45px;"><!-- Swords -->
                                    <col style="width: 70px;"><!-- Ability -->
                                    <col style="width: 100px;"><!-- Agent -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('starter', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('starter');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('starter');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('starter', 'name')">Name<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('starter', 'source')">Set<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('starter', 'compatibility')">Compat<div class="resize-handle"></div></th>
                                        <th rowspan="2" class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('starter', 'count_per_player')">Count/Player<div class="resize-handle"></div></th>
                                        <th colspan="7" class="group-header">Access</th>
                                        <th colspan="3" class="group-header">Reveal</th>
                                        <th rowspan="2" class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('starter', 'agent_ability')">Agent<div class="resize-handle"></div></th>
                                    </tr>
                                    <tr>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('starter', 'green_access')">Green<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('starter', 'purple_access')">Purple<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('starter', 'yellow_access')">Yellow<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('starter', 'emperor_access')">Emperor<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('starter', 'spacing_guild_access')">Spacing Guild<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 40px; cursor: pointer;" onclick="sortResourceTable('starter', 'bene_gesserit_access')">BG<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 45px; cursor: pointer;" onclick="sortResourceTable('starter', 'fremen_access')">Fremen<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('starter', 'reveal_persuasion')">Persuasion<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 50px; cursor: pointer;" onclick="sortResourceTable('starter', 'reveal_swords')">Swords<div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 70px; cursor: pointer;" onclick="sortResourceTable('starter', 'reveal_ability')">Ability<div class="resize-handle"></div></th>
                                    </tr>
                                </thead>
                                <tbody id="starter-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove starter cards from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="starter-stats">
                            <p class="text-muted">No starter cards selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conflict Panel -->
            <div class="tab-pane fade" id="conflict-panel" role="tabpanel">
                <div class="row">
                    <div class="col-12">
                        <h4 class="d-inline-block">Conflict Cards <span class="badge bg-secondary" id="conflict-available-count">0</span></h4>
                        <button class="btn btn-info btn-sm ms-3" onclick="showPhotoScanDialog('conflict')">ðŸ“· Scan Resources from Photo</button>
                        <div class="table-responsive" style="max-height: 500px; overflow: auto;">
                            <table class="table table-sm table-hover table-bordered" style="table-layout: fixed;">
                                <colgroup>
                                    <col style="width: 68px;"><!-- Selected -->
                                    <col style="width: 150px;"><!-- Name -->
                                    <col style="width: 80px;"><!-- Set -->
                                    <col style="width: 100px;"><!-- Compatibility -->
                                    <col style="width: 80px;"><!-- Conflict Level -->
                                    <col style="width: 80px;"><!-- VPs Available -->
                                    <col style="width: 200px;"><!-- First Place -->
                                    <col style="width: 200px;"><!-- Second Place -->
                                    <col style="width: 200px;"><!-- Third Place -->
                                </colgroup>
                                <thead class="sticky-top bg-white">
                                    <tr>
                                        <th rowspan="2" class="resizable sortable" style="width: 68px; cursor: pointer;" onclick="sortResourceTable('conflict', 'selected')">Selected
                                            <button class="btn btn-sm btn-outline-success" style="padding: 0px 3px; font-size: 0.7rem; margin-left: 2px;" onclick="event.stopPropagation(); selectAllResources('conflict');" title="Select all to Count">+</button>
                                            <button class="btn btn-sm btn-outline-danger" style="padding: 0px 3px; font-size: 0.7rem;" onclick="event.stopPropagation(); deselectAllResources('conflict');" title="Deselect all">-</button>
                                            <div class="resize-handle"></div></th>
                                        <th class="resizable sortable" style="width: 150px; cursor: pointer;" onclick="sortResourceTable('conflict', 'name')">Name</th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('conflict', 'source')">Set</th>
                                        <th class="resizable sortable" style="width: 100px; cursor: pointer;" onclick="sortResourceTable('conflict', 'compatibility')">Compatibility</th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('conflict', 'conflict_level')">Conflict Level</th>
                                        <th class="resizable sortable" style="width: 80px; cursor: pointer;" onclick="sortResourceTable('conflict', 'vps_available')">VPs Available</th>
                                        <th class="resizable sortable" style="width: 200px; cursor: pointer;" onclick="sortResourceTable('conflict', 'first_place')">First Place</th>
                                        <th class="resizable sortable" style="width: 200px; cursor: pointer;" onclick="sortResourceTable('conflict', 'second_place')">Second Place</th>
                                        <th class="resizable sortable" style="width: 200px; cursor: pointer;" onclick="sortResourceTable('conflict', 'third_place')">Third Place</th>
                                    </tr>
                                </thead>
                                <tbody id="conflict-tbody"></tbody>
                            </table>
                        </div>
                        <small class="text-muted">Use +/- buttons to add/remove conflict cards from blend.</small>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Statistics</h5>
                        <div id="conflict-stats">
                            <p class="text-muted">No conflicts selected</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Load Blend Modal -->
    <div class="modal fade" id="loadBlendModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Load Blend File</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Remote Blends Section -->
                    <div class="blend-section mb-4" style="background: #e3f2fd; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h6 class="fw-bold">ðŸ“¦ Remote Blends (Server)</h6>
                        <p class="text-muted small mb-2">Pre-packaged blends from the server</p>
                        <div class="list-group" id="remoteBlendList" style="max-height: 250px; overflow-y: auto;">
                            <p class="text-muted p-2">Loading...</p>
                        </div>
                    </div>

                    <!-- Local File Upload Section -->
                    <div class="blend-section" style="background: #f3e5f5; padding: 15px; border-radius: 8px; border-left: 4px solid #9c27b0;">
                        <h6 class="fw-bold">ðŸ’¾ Local File (Your Computer)</h6>
                        <p class="text-muted small mb-2">Upload a .md file from your computer</p>

                        <!-- Drag and Drop Zone -->
                        <div id="dropZone" class="border border-2 border-dashed rounded p-4 text-center"
                             style="background-color: #fff; cursor: pointer;"
                             ondrop="handleDrop(event)"
                             ondragover="handleDragOver(event)"
                             ondragleave="handleDragLeave(event)"
                             onclick="document.getElementById('fileInput').click()">
                            <div class="mb-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-cloud-upload text-secondary" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383z"/>
                                    <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3z"/>
                                </svg>
                            </div>
                            <p class="mb-1"><strong>Drag & drop a .md file here</strong></p>
                            <p class="text-muted mb-0">or click to browse</p>
                            <input type="file" id="fileInput" accept=".md" style="display: none;" onchange="handleFileSelect(event)">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save As Modal -->
    <div class="modal fade" id="saveAsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save Blend</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="saveAsFilename" class="form-label">Filename:</label>
                        <input type="text" class="form-control" id="saveAsFilename" placeholder="My_Blend.md">
                        <small class="text-muted">Filename will automatically get .md extension if not provided</small>
                    </div>

                    <!-- Server Save Section (if available) -->
                    <div id="serverSaveSection" style="display: none;">
                        <h6 class="mb-2" style="color: #0d6efd;">ðŸ“¦ Save to Server</h6>
                        <p class="small text-muted mb-2">Save to server (available in Remote Blends)</p>
                        <div id="saveAsFileList" class="list-group mb-3" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; background: #f8f9fa;">
                            <p class="text-muted px-3 py-2 mb-0">Loading...</p>
                        </div>
                        <button type="button" class="btn btn-primary mb-3" onclick="saveToServer()">
                            ðŸ’¾ Save to Server
                        </button>
                    </div>

                    <!-- Download Section -->
                    <div>
                        <h6 class="mb-2" style="color: #198754;">ðŸ’¾ Download File</h6>
                        <p class="small text-muted mb-2">Download to your computer</p>
                        <button type="button" class="btn btn-success" onclick="saveAsDownload()">
                            â¬‡ï¸ Download
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div class="modal fade" id="apiKeyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ðŸ”‘ image AI API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <strong>API Key Required:</strong> This feature uses Google's image AI to scan cards from photos. You need a free API key from Google AI Studio.
                    </div>

                    <div class="mb-3">
                        <label for="geminiApiKeyInput" class="form-label">image AI API Key:</label>
                        <input type="text" class="form-control font-monospace" id="geminiApiKeyInput" placeholder="AIzaSy...">
                        <small class="text-muted">
                            <strong>Get your free API key:</strong><br>
                            1. Visit <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a><br>
                            2. Click "Create API Key"<br>
                            3. Copy the key (starts with "AIza")<br>
                            4. Paste it here
                        </small>
                    </div>

                    <div class="mb-3">
                        <label for="geminiModelSelect" class="form-label">Model:</label>
                        <select class="form-select" id="geminiModelSelect">
                            <option value="gemini-2.5-flash" selected>gemini-2.5-flash (Recommended - Best accuracy)</option>
                            <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (Faster, lighter)</option>
                        </select>
                        <small class="text-muted">
                            <strong>Flash:</strong> Best accuracy for card detection<br>
                            <strong>Flash Lite:</strong> Faster processing, lower token usage
                        </small>
                    </div>

                    <div class="alert alert-info mb-0">
                        <strong>Privacy:</strong> Your API key is stored locally in your browser. Images are sent to Google's API for processing.
                        <br><small>Free tier: 1,500 requests/day</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveApiKey()">Save & Continue</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Photo Scan Modal -->
    <div class="modal fade" id="photoScanModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="photoScanModalTitle">ðŸ“· Scan Resources from Photo</h5>
                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="showApiKeyDialog()" title="Change API Key or Model">
                        âš™ï¸ Settings
                    </button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <strong>How to use:</strong> Upload a photo of your <span id="resourceTypeName">resources</span>. Image AI will identify names and automatically select them.
                        <br><small>
                            Model: <strong id="currentModelDisplay">gemini-2.5-flash</strong> |
                            <a href="#" onclick="showApiKeyDialog(); return false;">Change model</a>
                        </small>
                    </div>

                    <!-- Resource Type Selection -->
                    <div class="mb-3">
                        <label class="form-label"><strong>Select resource type to scan:</strong></label>
                        <select id="scanResourceTypeSelect" class="form-select" onchange="changeScanResourceType()">
                            <option value="imperium">Imperium Cards</option>
                            <option value="intrigue">Intrigue Cards</option>
                            <option value="tleilax">Tleilax Cards</option>
                            <option value="reserve">Reserve Cards</option>
                            <option value="tech">Tech Tiles</option>
                            <option value="contracts">Contracts</option>
                            <option value="leader">Leaders</option>
                            <option value="sardaukar">Sardaukar</option>
                            <option value="starter">Starter Cards</option>
                            <option value="conflict">Conflict Cards</option>
                        </select>
                    </div>

                    <!-- Input Method Selection -->
                    <div class="mb-3">
                        <label class="form-label">Choose input method:</label>
                        <div class="btn-group w-100" role="group">
                            <input type="radio" class="btn-check" name="inputMethod" id="inputMethodFile" autocomplete="off" checked>
                            <label class="btn btn-outline-primary" for="inputMethodFile" onclick="switchInputMethod('file')">ðŸ“ Upload File</label>

                            <input type="radio" class="btn-check" name="inputMethod" id="inputMethodCamera" autocomplete="off">
                            <label class="btn btn-outline-primary" for="inputMethodCamera" onclick="switchInputMethod('camera')">ðŸ“· Use Camera</label>

                            <input type="radio" class="btn-check" name="inputMethod" id="inputMethodClipboard" autocomplete="off">
                            <label class="btn btn-outline-primary" for="inputMethodClipboard" onclick="switchInputMethod('clipboard')">ðŸ“‹ Paste Image</label>
                        </div>
                    </div>

                    <!-- File Input -->
                    <div class="mb-3" id="fileInputContainer">
                        <label for="photoInput" class="form-label">Choose photo:</label>
                        <input type="file" class="form-control" id="photoInput" accept="image/*">
                        <small class="text-muted">Supported: JPG, PNG, WebP. Works best with clear, well-lit photos.</small>
                    </div>

                    <!-- Camera Input -->
                    <div class="mb-3" id="cameraInputContainer" style="display: none;">
                        <label class="form-label">Take photo:</label>
                        <video id="cameraPreview" autoplay playsinline style="width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px; display: none;"></video>
                        <canvas id="cameraCanvas" style="display: none;"></canvas>
                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary" id="startCameraBtn" onclick="startCamera()">
                                ðŸ“· Start Camera
                            </button>
                            <button type="button" class="btn btn-success" id="capturePhotoBtn" onclick="capturePhoto()" style="display: none;">
                                ðŸ“¸ Capture Photo
                            </button>
                            <button type="button" class="btn btn-secondary" id="retakePhotoBtn" onclick="retakePhoto()" style="display: none;">
                                ðŸ”„ Retake
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">Click "Start Camera" to use your device camera.</small>
                    </div>

                    <!-- Clipboard Input -->
                    <div class="mb-3" id="clipboardInputContainer" style="display: none;">
                        <label class="form-label">Paste image from clipboard:</label>
                        <div class="border rounded p-4 text-center" id="clipboardDropArea" style="background-color: #f8f9fa; min-height: 150px; cursor: pointer;" tabindex="0">
                            <div id="clipboardInstructions">
                                <i class="fs-1">ðŸ“‹</i>
                                <p class="mt-2 mb-0"><strong>Press Ctrl+V (or Cmd+V on Mac)</strong></p>
                                <p class="text-muted small">Or click here and paste</p>
                                <p class="text-muted small">You can paste screenshots or copied images</p>
                            </div>
                            <div id="clipboardPreview" style="display: none;">
                                <img id="clipboardImage" class="img-fluid" style="max-height: 300px;" alt="Pasted image">
                                <div class="mt-2">
                                    <button type="button" class="btn btn-success btn-sm" onclick="processClipboardImage()">
                                        âœ… Process This Image
                                    </button>
                                    <button type="button" class="btn btn-secondary btn-sm" onclick="clearClipboardImage()">
                                        ðŸ—‘ï¸ Clear
                                    </button>
                                </div>
                            </div>
                        </div>
                        <small class="text-muted d-block mt-2">Copy an image (screenshot, etc.) and paste it here using Ctrl+V or Cmd+V.</small>
                    </div>

                    <!-- Status -->
                    <div id="scanStatus" class="mb-3">
                        <p class="text-muted mb-0"><em>Ready to scan. Upload a photo to begin.</em></p>
                    </div>

                    <!-- Image Preview -->
                    <div id="photoPreviewContainer" style="display: none;">
                        <img id="photoPreview" class="img-fluid border rounded" alt="Preview" style="max-height: 400px;">
                    </div>

                    <!-- Results -->
                    <div id="scanResults" style="display: none;" class="mt-3">
                        <h6 class="mb-2">Detected Resources:</h6>
                        <div id="detectedCardsList" class="list-group">
                            <!-- Dynamically populated with checkboxes -->
                        </div>
                        <div class="mt-3 d-flex gap-2">
                            <button type="button" class="btn btn-success" onclick="addSelectedDetectedResources()">
                                âœ… Add Detected Resources
                            </button>
                            <button type="button" class="btn btn-danger" onclick="removeSelectedDetectedResources()">
                                âŒ Remove Selected Resources
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global state
        let allResources = {};
        let selectedResources = {
            imperium: [], intrigue: [], tleilax: [], reserve: [], tech: [],
            contracts: [], leader: [], sardaukar: [], starter: [], conflict: []
        };

        // Multi-row selection state
        let multiSelectState = {
            isSelecting: false,
            selectedRows: new Set(),
            currentType: null
        };

        // Initialize multi-selection event handlers for a table body
        function initializeMultiSelect(tbody, resourceType) {
            // Mouse down to start selection
            tbody.addEventListener('mousedown', (e) => {
                const row = e.target.closest('tr.resource-row');
                if (!row) return;

                // Don't start drag selection if clicking on a button
                if (e.target.closest('button')) return;

                // Clear previous selection if not holding Ctrl/Cmd
                if (!e.ctrlKey && !e.metaKey) {
                    clearMultiSelection();
                }

                multiSelectState.isSelecting = true;
                multiSelectState.currentType = resourceType;

                toggleRowSelection(row);
            });

            // Mouse move to extend selection while dragging
            tbody.addEventListener('mouseover', (e) => {
                if (!multiSelectState.isSelecting) return;
                if (multiSelectState.currentType !== resourceType) return;

                const row = e.target.closest('tr.resource-row');
                if (row && !multiSelectState.selectedRows.has(row)) {
                    toggleRowSelection(row, true); // Force add when dragging
                }
            });

            // Double-click to select all rows with matching column value
            tbody.addEventListener('dblclick', (e) => {
                const cell = e.target.closest('td');
                const row = e.target.closest('tr.resource-row');
                if (!cell || !row) return;

                // Don't handle double-click on buttons
                if (e.target.closest('button')) return;

                // Get the column index of the clicked cell
                const cellIndex = Array.from(row.cells).indexOf(cell);
                if (cellIndex < 0) return;

                // Get the value to match (use textContent, trimmed)
                const matchValue = cell.textContent.trim();

                // Clear previous selection
                clearMultiSelection();

                multiSelectState.currentType = resourceType;

                // Find all rows with matching value in the same column
                const allRows = tbody.querySelectorAll('tr.resource-row');
                allRows.forEach(r => {
                    const targetCell = r.cells[cellIndex];
                    if (targetCell && targetCell.textContent.trim() === matchValue) {
                        toggleRowSelection(r, true);
                    }
                });
            });
        }

        // Toggle row selection
        function toggleRowSelection(row, forceAdd = false) {
            if (forceAdd || !multiSelectState.selectedRows.has(row)) {
                multiSelectState.selectedRows.add(row);
                row.classList.add('multi-selected');
            } else {
                multiSelectState.selectedRows.delete(row);
                row.classList.remove('multi-selected');
            }
        }

        // Clear all multi-selection
        function clearMultiSelection() {
            multiSelectState.selectedRows.forEach(row => {
                row.classList.remove('multi-selected');
            });
            multiSelectState.selectedRows.clear();
            multiSelectState.currentType = null;
        }

        // Global mouse up to end selection
        document.addEventListener('mouseup', () => {
            multiSelectState.isSelecting = false;
        });

        // Get selected row data for +/- operations
        function getMultiSelectedRowsData() {
            const rowsData = [];
            multiSelectState.selectedRows.forEach(row => {
                const incrementBtn = row.querySelector('button[data-action="increment"]');
                if (incrementBtn) {
                    const reward = incrementBtn.getAttribute('data-reward');
                    const resourceId = incrementBtn.getAttribute('data-resource-id');

                    // Build uniqueProps object if needed
                    let uniqueProps = undefined;
                    if (reward) {
                        uniqueProps = uniqueProps || {};
                        uniqueProps.reward = reward;
                    }
                    if (resourceId !== null && resourceId !== undefined && resourceId !== '') {
                        uniqueProps = uniqueProps || {};
                        uniqueProps.resource_id = parseInt(resourceId);
                    }

                    rowsData.push({
                        row: row,
                        type: incrementBtn.getAttribute('data-type'),
                        name: (incrementBtn.getAttribute('data-name') || '').replace(/\\'/g, "'"),
                        source: (incrementBtn.getAttribute('data-source') || '').replace(/\\'/g, "'"),
                        maxCount: parseInt(incrementBtn.getAttribute('data-max')) || 999,
                        uniqueProps: uniqueProps
                    });
                }
            });
            return rowsData;
        }

        // Increment/decrement for all multi-selected rows
        function incrementMultiSelected() {
            const rowsData = getMultiSelectedRowsData();
            if (rowsData.length === 0) return false;

            rowsData.forEach(data => {
                incrementSelected(data.type, data.name, data.source, data.maxCount, data.uniqueProps);
            });
            return true;
        }

        function decrementMultiSelected() {
            const rowsData = getMultiSelectedRowsData();
            if (rowsData.length === 0) return false;

            rowsData.forEach(data => {
                decrementSelected(data.type, data.name, data.source, data.uniqueProps);
            });
            return true;
        }

        // Setup button handlers and multi-select for a resource table
        function setupResourceTableHandlers(tbody, resourceType) {
            // Add click event listeners for +/- buttons
            tbody.querySelectorAll('button[data-action]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.getAttribute('data-action');
                    const type = btn.getAttribute('data-type');
                    const name = (btn.getAttribute('data-name') || '').replace(/\\'/g, "'");
                    const source = (btn.getAttribute('data-source') || '').replace(/\\'/g, "'");
                    const maxCount = parseInt(btn.getAttribute('data-max')) || 999;

                    // Handle uniqueProps for contracts (data-reward) and conflicts (data-resource-id)
                    const reward = btn.getAttribute('data-reward');
                    const resourceId = btn.getAttribute('data-resource-id');

                    let uniqueProps = undefined;
                    if (reward) {
                        uniqueProps = uniqueProps || {};
                        uniqueProps.reward = reward;
                    }
                    if (resourceId !== null && resourceId !== undefined && resourceId !== '') {
                        uniqueProps = uniqueProps || {};
                        uniqueProps.resource_id = parseInt(resourceId);
                    }

                    // Check if this row is part of a multi-selection
                    const row = btn.closest('tr.resource-row');
                    const isMultiSelected = row && multiSelectState.selectedRows.has(row) && multiSelectState.selectedRows.size > 1;

                    if (action === 'increment') {
                        if (isMultiSelected) {
                            incrementMultiSelected();
                        } else {
                            incrementSelected(type, name, source, maxCount, uniqueProps);
                        }
                    } else if (action === 'decrement') {
                        if (isMultiSelected) {
                            decrementMultiSelected();
                        } else {
                            decrementSelected(type, name, source, uniqueProps);
                        }
                    }
                });
            });

            // Initialize multi-selection for this table
            initializeMultiSelect(tbody, resourceType);
        }

        // Auto-resize textarea to fit content
        function autoResizeTextarea(textarea) {
            if (!textarea) return;

            // Create a hidden clone to measure the content height accurately
            const clone = textarea.cloneNode(false);
            clone.style.cssText = `
                position: absolute;
                visibility: hidden;
                height: auto;
                min-height: 0;
                max-height: none;
                width: ${textarea.offsetWidth || 400}px;
                padding: ${getComputedStyle(textarea).padding};
                border: ${getComputedStyle(textarea).border};
                font: ${getComputedStyle(textarea).font};
                line-height: ${getComputedStyle(textarea).lineHeight};
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow: hidden;
            `;
            clone.value = textarea.value;

            document.body.appendChild(clone);
            const contentHeight = clone.scrollHeight;
            document.body.removeChild(clone);

            // Set height with minimum
            const minHeight = 60;
            textarea.style.height = Math.max(contentHeight, minHeight) + 'px';
        }

        // Initialize auto-resize for Overview textareas
        function initOverviewTextareas() {
            const textareas = [
                document.getElementById('overview-description'),
                document.getElementById('overview-leader-selection'),
                document.getElementById('overview-house-rules')
            ];

            textareas.forEach(textarea => {
                if (textarea) {
                    // Set initial height
                    autoResizeTextarea(textarea);
                    // Add input listener for dynamic resizing
                    textarea.addEventListener('input', () => autoResizeTextarea(textarea));
                }
            });
        }

        // Sorting state for each resource type
        let sortState = {};
        Object.keys(selectedResources).forEach(type => {
            sortState[type] = { column: null, direction: 'asc' };
        });

        // Resource type configurations
        const resourceConfigs = {
            imperium: { nameProp: 'name', costProp: 'persuasion_cost', hasSet: true },
            intrigue: { nameProp: 'name', costProp: null, hasSet: true },
            tleilax: { nameProp: 'name', costProp: 'specimen_cost', hasSet: true },
            reserve: { nameProp: 'name', costProp: 'persuasion_cost', hasSet: true },
            tech: { nameProp: 'name', costProp: 'spice_cost', hasSet: true },
            contracts: { nameProp: 'objective', costProp: null, hasSet: true },
            leader: { nameProp: 'name', costProp: null, hasSet: true, extraProp: 'house' },
            sardaukar: { nameProp: 'name', costProp: null, hasSet: false },
            starter: { nameProp: 'name', costProp: null, hasSet: true },
            conflict: { nameProp: 'name', costProp: null, hasSet: true }
        };

        // Centralized color scheme for all themed elements
        const COLOR_SCHEME = {
            // Expansion/Set colors - light backgrounds
            sets: {
                'Imperium': '#F5DEB3',        // Wheat (Sand color)
                'Base': '#F5DEB3',            // Wheat (Sand color, same as Imperium)
                'Ix': '#B0E0E6',              // Powder Blue
                'Rise of Ix': '#B0E0E6',      // Powder Blue
                'Immortality': '#E2EFDA',     // Light Green
                'Uprising': '#DEB887',        // Burlywood (light brown)
                'Bloodlines': '#FF6B6B',      // Coral Red
                'Promo': '#E0CFFC'            // Light Purple
            },
            // Access colors - matching color names
            access: {
                'Green': '#90EE90',           // Light Green
                'Purple': '#DDA0DD',          // Plum (Purple)
                'Yellow': '#FFFF99',          // Light Yellow
                'Emperor': '#C0C0C0',         // Silver (Gray)
                'Spacing Guild': '#FFB6B6',   // Light Red
                'Guild': '#FFB6B6',           // Light Red (alias)
                'Bene Gesserit': '#E6D5E6',   // Lilac
                'Bg': '#E6D5E6',              // Lilac (alias)
                'Fremen': '#ADD8E6',          // Light Blue
                'Spy': '#D3D3D3'              // Light Gray
            },
            // Affiliation colors - matching access colors
            affiliation: {
                'Emperor': '#C0C0C0',         // Silver (Gray)
                'Spacing Guild': '#FFB6B6',   // Light Red
                'Guild': '#FFB6B6',           // Light Red (alias)
                'Bene Gesserit': '#E6D5E6',   // Lilac
                'Bg': '#E6D5E6',              // Lilac (alias)
                'Fremen': '#ADD8E6'           // Light Blue
            },
            // Default bar color
            default: {
                gradient: 'linear-gradient(90deg, rgba(77, 148, 255, 1), rgba(128, 179, 255, 0.6))'
            }
        };

        // Helper function to get color for a category
        function getColorForCategory(category, label) {
            if (!category || !label) return null;

            // Normalize label - trim and use for case-insensitive lookup
            const normalizedLabel = label.trim();

            // Check which category and return appropriate color
            let colorMap = null;
            if (category === 'set') {
                colorMap = COLOR_SCHEME.sets;
            } else if (category === 'access') {
                colorMap = COLOR_SCHEME.access;
            } else if (category === 'affiliation') {
                colorMap = COLOR_SCHEME.affiliation;
            }

            if (!colorMap) return null;

            // First try exact match
            if (colorMap[normalizedLabel]) {
                const color = colorMap[normalizedLabel];
                console.log(`Color match (exact): category="${category}", label="${normalizedLabel}", color="${color}"`);
                return color;
            }

            // Try case-insensitive match
            for (const key in colorMap) {
                if (key.toLowerCase() === normalizedLabel.toLowerCase()) {
                    const color = colorMap[key];
                    console.log(`Color match (case-insensitive): category="${category}", label="${normalizedLabel}", matched="${key}", color="${color}"`);
                    return color;
                }
            }

            console.log(`No color match: category="${category}", label="${normalizedLabel}"`);
            return null;
        }

        // Load all resources on page load
        Promise.all([
            detectServerFeatures(),
            loadResources()
        ]).then(([features, resources]) => {
            allResources = resources;
            console.log('Loaded resources:', Object.keys(resources).map(k => `${k}: ${resources[k].length}`));

            // Show/hide server features in UI
            if (features.canSaveToServer) {
                document.getElementById('serverSaveOptions')?.style.setProperty('display', 'block');
                console.log('âœ… Server save enabled - running locally');
            } else {
                console.log('ðŸ“¦ Static hosting mode - downloads only');
            }

            // Debug: Show sample resource to see field values
            if (resources.imperium && resources.imperium.length > 0) {
                const sample = resources.imperium[0];
                console.log('Sample Imperium card:', {
                    name: sample.name,
                    source: sample.source,
                    card_set: sample.card_set
                });
            }

            initializeAllTabs();
        }).catch(error => {
            console.error('Initialization error:', error);
            alert('Failed to load application. Please refresh the page.');
        });

        function initializeAllTabs() {
            Object.keys(resourceConfigs).forEach(type => {
                if (allResources[type]) {
                    initializeTab(type);
                }
            });

            // Initialize Overview tab textareas with auto-resize
            initOverviewTextareas();

            // Initial update of required sets (Board tab is active by default)
            updateRequiredSets();
        }

        function initializeTab(type) {
            const tbody = document.getElementById(`${type}-tbody`);
            if (!tbody) return;

            tbody.innerHTML = '';

            // Get sorted resources if sorting is active
            let resources;
            if (sortState[type].column) {
                resources = getSortedResources(type, sortState[type].column, sortState[type].direction);
            } else {
                resources = allResources[type] || [];
            }

            // Call detailed rendering function for each type
            switch(type) {
                case 'imperium':
                    initializeImperiumDetailed(resources);
                    break;
                case 'intrigue':
                    initializeIntrigueDetailed(resources);
                    break;
                case 'tleilax':
                    initializeTleilaxDetailed(resources);
                    break;
                case 'reserve':
                    initializeReserveDetailed(resources);
                    break;
                case 'tech':
                    initializeTechDetailed(resources);
                    break;
                case 'contracts':
                    initializeContractsDetailed(resources);
                    break;
                case 'leader':
                    initializeLeaderDetailed(resources);
                    break;
                case 'sardaukar':
                    initializeSardaukarDetailed(resources);
                    break;
                case 'starter':
                    initializeStarterDetailed(resources);
                    break;
                case 'conflict':
                    initializeConflictDetailed(resources);
                    break;
                default:
                    console.warn('No detailed renderer for type:', type);
            }
        }

        // Helper functions
        function truncate(str, len) {
            if (!str || str.length <= len) return str || '';
            return str.substring(0, len) + '...';
        }

        function hasX(val) {
            return val === true || val === 'X' || val === 'x' || val === '1';
        }

        function generateDuneCardHubUrl(cardName, resourceType, expansion) {
            // Use + for spaces instead of %20 for cleaner URLs
            const searchTerm = cardName.toLowerCase().replace(/ /g, '+');
            return `https://dunecardshub.com/?search=${searchTerm}`;
        }

        function createCardNameLink(cardName, resourceType, expansion) {
            const url = generateDuneCardHubUrl(cardName, resourceType, expansion);
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color: #0066cc; text-decoration: none;">${cardName}</a>`;
        }

        // Increment/Decrement selected count functions
        function incrementSelected(type, name, source, maxCount, uniqueProps = {}) {
            // Find the specific resource, considering unique properties for synonyms
            const resource = allResources[type].find(r => {
                const nameMatch = (r.name === name || r.objective === name);
                const sourceMatch = (r.source === source || r.card_set === source);

                if (!nameMatch || !sourceMatch) return false;

                // If resource_id is provided, use it for exact matching (most reliable)
                if (uniqueProps.resource_id !== undefined && r.resource_id !== uniqueProps.resource_id) return false;

                // Otherwise, fall back to other unique properties for synonyms
                if (uniqueProps.reward !== undefined && r.reward !== uniqueProps.reward) return false;
                if (uniqueProps.first_place !== undefined && r.first_place !== uniqueProps.first_place) return false;

                return true;
            });

            if (!resource) return;

            const currentCount = resource.selected || 0;
            if (currentCount < maxCount) {
                resource.selected = currentCount + 1;
                updateSelectedCountDisplay(type, name, source, uniqueProps);
                updateStatsForType(type);
                updateBadge(type);
            }
            // Silently ignore if maximum count reached
        }

        function decrementSelected(type, name, source, uniqueProps = {}) {
            // Find the specific resource, considering unique properties for synonyms
            const resource = allResources[type].find(r => {
                const nameMatch = (r.name === name || r.objective === name);
                const sourceMatch = (r.source === source || r.card_set === source);

                if (!nameMatch || !sourceMatch) return false;

                // If resource_id is provided, use it for exact matching (most reliable)
                if (uniqueProps.resource_id !== undefined && r.resource_id !== uniqueProps.resource_id) return false;

                // Otherwise, fall back to other unique properties for synonyms
                if (uniqueProps.reward !== undefined && r.reward !== uniqueProps.reward) return false;
                if (uniqueProps.first_place !== undefined && r.first_place !== uniqueProps.first_place) return false;

                return true;
            });

            if (!resource) return;

            const currentCount = resource.selected || 0;
            if (currentCount > 0) {
                resource.selected = currentCount - 1;
                updateSelectedCountDisplay(type, name, source, uniqueProps);
                updateStatsForType(type);
                updateBadge(type);
            }
        }

        function updateSelectedCountDisplay(type, name, source, uniqueProps = {}) {
            // Find the specific resource, considering unique properties for synonyms
            const resource = allResources[type].find(r => {
                const nameMatch = (r.name === name || r.objective === name);
                const sourceMatch = (r.source === source || r.card_set === source);

                if (!nameMatch || !sourceMatch) return false;

                // If resource_id is provided, use it for exact matching (most reliable)
                if (uniqueProps.resource_id !== undefined && r.resource_id !== uniqueProps.resource_id) return false;

                // Otherwise, fall back to other unique properties for synonyms
                if (uniqueProps.reward !== undefined && r.reward !== uniqueProps.reward) return false;
                if (uniqueProps.first_place !== undefined && r.first_place !== uniqueProps.first_place) return false;

                return true;
            });

            if (!resource) return;

            // Build the same unique ID that was created during rendering
            let idSuffix = '';
            if (type === 'contracts' && resource.reward) {
                const rewardHash = resource.reward.substring(0, 20).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                idSuffix = `-${rewardHash}`;
            } else if (type === 'conflict') {
                // Use resource_id for conflicts to ensure uniqueness
                const resourceId = resource.resource_id !== undefined ? resource.resource_id : '';
                idSuffix = `-${resourceId}`;
            }

            const id = `${type}-selected-${name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${source.replace(/\s+/g, '-')}${idSuffix}`;
            const elem = document.getElementById(id);
            if (elem) {
                elem.textContent = resource.selected || 0;

                // Update the row's has-selection class
                const row = elem.closest('tr');
                if (row) {
                    if (resource.selected > 0) {
                        row.classList.add('has-selection');
                    } else {
                        row.classList.remove('has-selection');
                    }
                }
            }
        }

        function updateRowSelectionClass(type, name, source, uniqueProps = {}) {
            // Find the row and toggle has-selection class
            const resource = allResources[type].find(r => {
                const nameMatch = (r.name === name || r.objective === name);
                const sourceMatch = (r.source === source || r.card_set === source);

                if (!nameMatch || !sourceMatch) return false;

                // If unique properties provided, match by those too (for synonyms)
                if (uniqueProps.reward !== undefined && r.reward !== uniqueProps.reward) return false;
                if (uniqueProps.first_place !== undefined && r.first_place !== uniqueProps.first_place) return false;

                return true;
            });

            if (!resource) return;

            // Build the same unique ID that was created during rendering
            let idSuffix = '';
            if (type === 'contracts' && resource.reward) {
                const rewardHash = resource.reward.substring(0, 20).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                idSuffix = `-${rewardHash}`;
            } else if (type === 'conflict' && resource.first_place) {
                const firstPlaceHash = resource.first_place.substring(0, 20).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '');
                idSuffix = `-${firstPlaceHash}`;
            }

            const id = `${type}-selected-${name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${source.replace(/\s+/g, '-')}${idSuffix}`;
            const elem = document.getElementById(id);
            if (elem) {
                // Find the parent tr
                const tr = elem.closest('tr');
                if (tr) {
                    if (resource.selected > 0) {
                        tr.classList.add('has-selection');
                    } else {
                        tr.classList.remove('has-selection');
                    }
                }
            }
        }

        // Select all resources of a type to their Count value
        function selectAllResources(type) {
            if (!allResources[type]) return;

            allResources[type].forEach(resource => {
                // Set selected to the resource's count value (or 1 if no count or for unique items)
                let maxCount = 1;
                if (resource.count !== undefined && resource.count !== null && resource.count !== '') {
                    maxCount = parseInt(resource.count) || 1;
                }
                // For unique resource types (tech, leader, conflict), always use 1
                if (type === 'tech' || type === 'leader' || type === 'conflict') {
                    maxCount = 1;
                }
                resource.selected = maxCount;
            });

            // Refresh the UI
            initializeTab(type);
            updateStatsForType(type);
            updateBadge(type);
        }

        // Deselect all resources of a type (set to 0)
        function deselectAllResources(type) {
            if (!allResources[type]) return;

            allResources[type].forEach(resource => {
                resource.selected = 0;
            });

            // Refresh the UI
            initializeTab(type);
            updateStatsForType(type);
            updateBadge(type);
        }

        function updateStatsForType(type) {
            switch(type) {
                case 'imperium':
                    updateImperiumStats();
                    break;
                case 'intrigue':
                    updateIntrigueStats();
                    break;
                case 'tleilax':
                    updateTleilaxStats();
                    break;
                case 'reserve':
                    updateReserveStats();
                    break;
                case 'tech':
                    updateTechStats();
                    break;
                case 'contracts':
                    updateContractsStats();
                    break;
                case 'leader':
                    updateLeaderStats();
                    break;
                case 'sardaukar':
                    updateSardaukarStats();
                    break;
                case 'starter':
                    updateStarterStats();
                    break;
                case 'conflict':
                    updateConflictStats();
                    break;
            }
        }

        // Calculate and display required sets based on all selections
        function updateRequiredSets() {
            const requiredSets = new Set();

            // Check main board selection
            const mainBoard = document.querySelector('input[name="mainBoard"]:checked')?.value;
            if (mainBoard) {
                if (mainBoard === 'imperium') {
                    requiredSets.add('Imperium');
                } else if (mainBoard === 'uprising') {
                    requiredSets.add('Uprising');
                }
            }

            // Check additional boards
            document.querySelectorAll('#board-panel input[type="checkbox"]:checked').forEach(cb => {
                const value = cb.value;
                if (value === 'choam' || value === 'ix') {
                    requiredSets.add('Rise of Ix');
                }
                if (value === 'tleilax' || value === 'research') {
                    requiredSets.add('Immortality');
                }
                if (value === 'embassy') {
                    requiredSets.add('Bloodlines');
                }
            });

            // Check all resource types for selected items
            const resourceTypes = ['imperium', 'intrigue', 'tleilax', 'reserve', 'tech', 'contracts', 'leader', 'sardaukar', 'starter', 'conflict', 'rival', 'navigation'];

            resourceTypes.forEach(type => {
                if (!allResources[type]) return;

                allResources[type].forEach(resource => {
                    if (resource.selected && resource.selected > 0) {
                        // Get source from various possible fields
                        const source = resource.source || resource.card_set || resource.set || '';
                        if (source) {
                            const normalizedSource = normalizeSetName(source);
                            if (normalizedSource) {
                                requiredSets.add(normalizedSource);
                            }
                        }
                    }
                });
            });

            // Update the display
            const container = document.getElementById('requiredSetsContainer');
            if (container) {
                if (requiredSets.size === 0) {
                    container.innerHTML = '<span class="text-muted">No sets selected yet</span>';
                } else {
                    // Sort sets in a logical order
                    const setOrder = ['Imperium', 'Uprising', 'Rise of Ix', 'Immortality', 'Bloodlines', 'Promo', 'Ecaz & Moritani'];
                    const sortedSets = Array.from(requiredSets).sort((a, b) => {
                        const indexA = setOrder.indexOf(a);
                        const indexB = setOrder.indexOf(b);
                        if (indexA === -1 && indexB === -1) return a.localeCompare(b);
                        if (indexA === -1) return 1;
                        if (indexB === -1) return -1;
                        return indexA - indexB;
                    });

                    container.innerHTML = sortedSets.map(set => {
                        // Use expansion colors for badges
                        let badgeClass = 'bg-primary';
                        const lowerSet = set.toLowerCase();
                        if (lowerSet.includes('imperium') || lowerSet === 'base') badgeClass = 'expansion-base';
                        else if (lowerSet.includes('uprising')) badgeClass = 'expansion-uprising';
                        else if (lowerSet.includes('ix')) badgeClass = 'expansion-ix';
                        else if (lowerSet.includes('immortality')) badgeClass = 'expansion-immortality';
                        else if (lowerSet.includes('bloodlines')) badgeClass = 'expansion-bloodlines';
                        else if (lowerSet.includes('promo')) badgeClass = 'expansion-promo';

                        return `<span class="badge ${badgeClass} me-2 mb-1" style="font-size: 0.95em; padding: 6px 12px;">${set}</span>`;
                    }).join('');
                }
            }
        }

        // Normalize set names to consistent display names
        function normalizeSetName(source) {
            if (!source) return null;
            const lower = source.toLowerCase().trim();

            if (lower === 'base' || lower === 'imperium' || lower === 'dune: imperium') return 'Imperium';
            if (lower === 'ix' || lower === 'rise of ix' || lower.includes('rise of ix')) return 'Rise of Ix';
            if (lower === 'immortality' || lower.includes('immortality')) return 'Immortality';
            if (lower === 'uprising' || lower.includes('uprising')) return 'Uprising';
            if (lower === 'bloodlines' || lower.includes('bloodlines')) return 'Bloodlines';
            if (lower === 'promo' || lower.includes('promo')) return 'Promo';
            if (lower.includes('ecaz') || lower.includes('moritani')) return 'Ecaz & Moritani';

            // Return capitalized original if no match
            return source.charAt(0).toUpperCase() + source.slice(1);
        }

        function initializeImperiumDetailed(cards) {
            const tbody = document.getElementById('imperium-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                // Add has-selection class if this card is selected
                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'imperium', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `imperium-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                // Build entire row with innerHTML
                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="imperium" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="imperium" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="${card.count || 999}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}" title="${card.name || ''}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || card.card_set || ''}</td>
                    <td class="compact">${card.count || '1'}</td>
                    <td class="compact">${parseFloat(card.cost || card.persuasion_cost || 0) || 0}</td>
                    <td title="${card.agent_ability || ''}">${truncate(card.agent_ability || '', 50)}</td>
                    <td title="${card.passive_ability || ''}">${truncate(card.passive_ability || '', 50)}</td>
                    <td title="${card.acquisition_bonus || ''}">${truncate(card.acquisition_bonus || '', 50)}</td>
                    <td class="compact">${card.reveal_persuasion && card.reveal_persuasion !== '0' && card.reveal_persuasion !== '0.0' ? parseFloat(card.reveal_persuasion) : ''}</td>
                    <td class="compact">${card.reveal_swords && card.reveal_swords !== '0' && card.reveal_swords !== '0.0' ? parseFloat(card.reveal_swords) : ''}</td>
                    <td title="${card.reveal_ability || ''}">${truncate(card.reveal_ability || '', 50)}</td>
                    <td class="compact">${card.tech || ''}</td>
                    <td class="compact">${card.shipping || ''}</td>
                    <td class="compact">${card.unload || ''}</td>
                    <td class="compact">${card.infiltration || ''}</td>
                    <td class="compact">${card.research || ''}</td>
                    <td class="compact">${card.grafting || ''}</td>
                    <td class="compact">${card.spies || ''}</td>
                    <td class="compact">${card.sandworms || ''}</td>
                    <td class="compact">${card.contracts || ''}</td>
                    <td class="compact">${card.sardaukar || ''}</td>
                    <td class="access-x access-green">${hasX(card.green_access) ? 'X' : ''}</td>
                    <td class="access-x access-purple">${hasX(card.purple_access) ? 'X' : ''}</td>
                    <td class="access-x access-yellow">${hasX(card.yellow_access) ? 'X' : ''}</td>
                    <td class="access-x access-emperor">${hasX(card.emperor_access) ? 'X' : ''}</td>
                    <td class="access-x access-guild">${hasX(card.spacing_guild_access) ? 'X' : ''}</td>
                    <td class="access-x access-bg">${hasX(card.bene_gesserit_access) ? 'X' : ''}</td>
                    <td class="access-x access-fremen">${hasX(card.fremen_access) ? 'X' : ''}</td>
                    <td class="access-x access-spy">${hasX(card.spy_access) ? 'X' : ''}</td>
                    <td class="affiliation-x access-emperor" style="width: 55px !important;">${hasX(card.emperor_affiliation) ? 'X' : ''}</td>
                    <td class="affiliation-x access-guild" style="width: 55px !important;">${hasX(card.spacing_guild_affiliation) ? 'X' : ''}</td>
                    <td class="affiliation-x access-bg" style="width: 55px !important;">${hasX(card.bene_gesserit_affiliation) ? 'X' : ''}</td>
                    <td class="affiliation-x access-fremen" style="width: 55px !important;">${hasX(card.fremen_affiliation) ? 'X' : ''}</td>
                    <td class="compact">${card.compatibility || 'All'}</td>
                    <td class="compact">${card.vps_available && parseFloat(card.vps_available) !== 0 && !isNaN(parseFloat(card.vps_available)) ? card.vps_available : ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'imperium');

            document.getElementById('imperium-available-count').textContent = cards.length;
            initializeResizing();
        }


        // Detailed rendering functions for other resource types
        function initializeIntrigueDetailed(cards) {
            const tbody = document.getElementById('intrigue-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                // Add has-selection class if selected
                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'intrigue', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `intrigue-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="intrigue" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="intrigue" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="${card.count || 999}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || card.card_set || ''}</td>
                    <td class="compact">${card.count || '1'}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.tech || ''}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.shipping || ''}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.research || ''}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.spies || ''}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.sandworms || ''}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.contracts || ''}</td>
                    <td class="compact" style="max-width: 50px !important;">${card.sardaukar || ''}</td>
                    <td title="${card.plot_effect || ''}">${truncate(card.plot_effect || '', 50)}</td>
                    <td title="${card.combat_effect || ''}">${truncate(card.combat_effect || '', 50)}</td>
                    <td title="${card.endgame_effect || ''}">${truncate(card.endgame_effect || '', 50)}</td>
                    <td class="compact">${card.vps_available && parseFloat(card.vps_available) !== 0 && !isNaN(parseFloat(card.vps_available)) ? card.vps_available : ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'intrigue');

            document.getElementById('intrigue-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeTleilaxDetailed(cards) {
            const tbody = document.getElementById('tleilax-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'tleilax', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `tleilax-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="tleilax" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="tleilax" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="1">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || card.card_set || ''}</td>
                    <td class="compact">${card.count || '1'}</td>
                    <td class="compact">${parseFloat(card.specimen_cost || 0) || 0}</td>
                    <td title="${card.agent_ability || ''}">${truncate(card.agent_ability || '', 50)}</td>
                    <td class="compact">${card.reveal_persuasion || ''}</td>
                    <td class="compact">${card.reveal_swords || ''}</td>
                    <td title="${card.reveal_ability || ''}">${truncate(card.reveal_ability || '', 50)}</td>
                    <td class="compact">${card.infiltration || ''}</td>
                    <td class="compact">${card.research || ''}</td>
                    <td class="compact">${card.grafting || ''}</td>
                    <td class="access-x access-green">${hasX(card.green_access) ? 'X' : ''}</td>
                    <td class="access-x access-purple">${hasX(card.purple_access) ? 'X' : ''}</td>
                    <td class="access-x access-yellow">${hasX(card.yellow_access) ? 'X' : ''}</td>
                    <td class="access-x access-emperor">${hasX(card.emperor_access) ? 'X' : ''}</td>
                    <td class="access-x access-guild">${hasX(card.spacing_guild_access) ? 'X' : ''}</td>
                    <td class="access-x access-bg">${hasX(card.bene_gesserit_access) ? 'X' : ''}</td>
                    <td class="access-x access-fremen">${hasX(card.fremen_access) ? 'X' : ''}</td>
                    <td class="compact">${card.vps_available && parseFloat(card.vps_available) !== 0 && !isNaN(parseFloat(card.vps_available)) ? card.vps_available : ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'tleilax');

            document.getElementById('tleilax-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeReserveDetailed(cards) {
            const tbody = document.getElementById('reserve-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'reserve', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `reserve-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="reserve" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="reserve" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="${card.count || 999}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || card.card_set || ''}</td>
                    <td class="compact">${card.count || '1'}</td>
                    <td class="compact">${parseFloat(card.persuasion_cost || 0) || 0}</td>
                    <td title="${card.agent_ability || ''}">${truncate(card.agent_ability || '', 50)}</td>
                    <td title="${card.passive_ability || ''}">${truncate(card.passive_ability || '', 50)}</td>
                    <td class="compact">${card.reveal_persuasion || ''}</td>
                    <td class="compact">${card.reveal_swords || ''}</td>
                    <td title="${card.reveal_ability || ''}">${truncate(card.reveal_ability || '', 50)}</td>
                    <td class="access-x access-green">${hasX(card.green_access) ? 'X' : ''}</td>
                    <td class="access-x access-purple">${hasX(card.purple_access) ? 'X' : ''}</td>
                    <td class="access-x access-yellow">${hasX(card.yellow_access) ? 'X' : ''}</td>
                    <td class="access-x access-emperor">${hasX(card.emperor_access) ? 'X' : ''}</td>
                    <td class="access-x access-guild">${hasX(card.spacing_guild_access) ? 'X' : ''}</td>
                    <td class="access-x access-bg">${hasX(card.bene_gesserit_access) ? 'X' : ''}</td>
                    <td class="access-x access-fremen">${hasX(card.fremen_access) ? 'X' : ''}</td>
                    <td class="access-x access-spy">${hasX(card.spy_access) ? 'X' : ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'reserve');

            document.getElementById('reserve-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeTechDetailed(cards) {
            const tbody = document.getElementById('tech-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'tech', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `tech-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="tech" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="tech" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="1">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || ''}</td>
                    <td class="compact">${card.compatibility || ''}</td>
                    <td class="compact">${card.spice_cost || ''}</td>
                    <td class="compact">${card.shipping || ''}</td>
                    <td class="compact">${card.spies || ''}</td>
                    <td class="compact">${card.sandworms || ''}</td>
                    <td class="compact">${card.contracts || ''}</td>
                    <td class="compact">${card.sardaukar || ''}</td>
                    <td class="compact">${card.vps_available && parseFloat(card.vps_available) !== 0 && !isNaN(parseFloat(card.vps_available)) ? card.vps_available : ''}</td>
                    <td title="${card.effect || ''}">${truncate(card.effect || '', 80)}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'tech');

            document.getElementById('tech-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeContractsDetailed(cards) {
            const tbody = document.getElementById('contracts-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.objective || card.name || '', 'contracts', card.source || card.card_set || '');
                const cardNameSafe = ((card.objective || card.name) || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const rewardSafe = (card.reward || '').replace(/"/g, '&quot;');
                // Create unique ID by including reward hash to differentiate synonyms
                const rewardHash = card.reward ? card.reward.substring(0, 20).replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '') : '';
                const countId = `contracts-selected-${(card.objective || card.name || '').replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}-${rewardHash}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="contracts" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-reward="${rewardSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="contracts" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="${card.count || 999}" data-reward="${rewardSafe}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || ''}</td>
                    <td class="compact">${card.count || '1'}</td>
                    <td title="${card.reward || ''}">${truncate(card.reward || '', 100)}</td>
                    <td class="compact">${card.rise_of_ix__specific || ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'contracts');

            document.getElementById('contracts-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeLeaderDetailed(cards) {
            const tbody = document.getElementById('leader-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'leader', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `leader-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="leader" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="leader" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="1">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || ''}</td>
                    <td class="compact">${card.compatibility || ''}</td>
                    <td>${card.house || ''}</td>
                    <td title="${card.starting_effect || ''}">${truncate(card.starting_effect || '', 100)}</td>
                    <td title="${card.leader_ability || ''}">${truncate(card.leader_ability || '', 100)}</td>
                    <td title="${card.signet_ring_ability || ''}">${truncate(card.signet_ring_ability || '', 100)}</td>
                    <td class="compact">${card.listed_complexity_level || ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'leader');

            document.getElementById('leader-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeSardaukarDetailed(cards) {
            const tbody = document.getElementById('sardaukar-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'sardaukar', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `sardaukar-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="sardaukar" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="sardaukar" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="${card.count || 999}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || ''}</td>
                    <td class="compact">${card.compatibility || ''}</td>
                    <td class="compact">${card.count || '1'}</td>
                    <td title="${card.effect || ''}">${truncate(card.effect || '', 150)}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'sardaukar');

            document.getElementById('sardaukar-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeStarterDetailed(cards) {
            const tbody = document.getElementById('starter-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'starter', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const countId = `starter-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="starter" data-name="${cardNameSafe}" data-source="${sourceSafe}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="starter" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="${card.count_per_player || 999}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || ''}</td>
                    <td class="compact">${card.compatibility || ''}</td>
                    <td class="compact">${card.count_per_player || ''}</td>
                    <td class="access-x access-green">${hasX(card.green_access) ? 'X' : ''}</td>
                    <td class="access-x access-purple">${hasX(card.purple_access) ? 'X' : ''}</td>
                    <td class="access-x access-yellow">${hasX(card.yellow_access) ? 'X' : ''}</td>
                    <td class="access-x access-emperor">${hasX(card.emperor_access) ? 'X' : ''}</td>
                    <td class="access-x access-guild">${hasX(card.spacing_guild_access) ? 'X' : ''}</td>
                    <td class="access-x access-bg">${hasX(card.bene_gesserit_access) ? 'X' : ''}</td>
                    <td class="access-x access-fremen">${hasX(card.fremen_access) ? 'X' : ''}</td>
                    <td class="compact">${card.reveal_persuation || ''}</td>
                    <td class="compact">${card.reveal_swords || ''}</td>
                    <td title="${card.reveal_ability || ''}">${truncate(card.reveal_ability || '', 50)}</td>
                    <td title="${card.agent_ability || ''}">${truncate(card.agent_ability || '', 80)}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'starter');

            document.getElementById('starter-available-count').textContent = cards.length;
            initializeResizing();
        }

        function initializeConflictDetailed(cards) {
            const tbody = document.getElementById('conflict-tbody');
            tbody.innerHTML = '';

            cards.forEach(card => {
                const tr = document.createElement('tr');
                tr.className = 'resource-row';

                if (card.selected && card.selected > 0) {
                    tr.classList.add('has-selection');
                }

                const cardNameLink = createCardNameLink(card.name || '', 'conflict', card.source || card.card_set || '');
                const cardNameSafe = (card.name || '').replace(/"/g, '&quot;');
                const sourceSafe = (card.source || card.card_set || '').replace(/"/g, '&quot;');
                const firstPlaceSafe = (card.first_place || '').replace(/"/g, '&quot;');
                // Use resource_id for unique ID to differentiate all conflicts, especially those with empty data
                const resourceId = card.resource_id !== undefined ? card.resource_id : '';
                const countId = `conflict-selected-${card.name.replace(/\s+/g, '-').replace(/[^a-zA-Z0-9-]/g, '')}-${(card.source || card.card_set || '').replace(/\s+/g, '-')}-${resourceId}`;

                tr.innerHTML = `
                    <td style="text-align: center; padding: 2px;">
                        <button class="btn btn-sm btn-outline-danger" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="decrement" data-type="conflict" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-first-place="${firstPlaceSafe}" data-resource-id="${resourceId}">-</button>
                        <span id="${countId}" style="display: inline-block; min-width: 20px; text-align: center; font-weight: bold; font-size: 0.85rem;">${card.selected || 0}</span>
                        <button class="btn btn-sm btn-outline-success" style="padding: 1px 4px; font-size: 0.75rem; line-height: 1;" data-action="increment" data-type="conflict" data-name="${cardNameSafe}" data-source="${sourceSafe}" data-max="1" data-first-place="${firstPlaceSafe}" data-resource-id="${resourceId}">+</button>
                    </td>
                    <td class="expansion-${card.card_set}">${cardNameLink}</td>
                    <td class="expansion-${card.card_set}">${card.source || ''}</td>
                    <td class="compact">${card.compatibility || ''}</td>
                    <td class="compact">${card.conflict_level || ''}</td>
                    <td class="compact">${card.vps_available && parseFloat(card.vps_available) !== 0 && !isNaN(parseFloat(card.vps_available)) ? card.vps_available : ''}</td>
                    <td title="${card.first_place || ''}">${card.first_place || ''}</td>
                    <td title="${card.second_place || ''}">${card.second_place || ''}</td>
                    <td title="${card.third_place || ''}">${card.third_place || ''}</td>
                `;

                tbody.appendChild(tr);
            });

            // Setup button handlers and multi-selection
            setupResourceTableHandlers(tbody, 'conflict');

            document.getElementById('conflict-available-count').textContent = cards.length;
            initializeResizing();
        }

        // Column resizing
        let isResizing = false;
        let currentColumn = null;
        let currentColElement = null;
        let startX = 0;
        let startWidth = 0;

        function initializeResizing() {
            // Remove old listeners to avoid duplicates
            const oldHandles = document.querySelectorAll('.resize-handle');
            oldHandles.forEach(handle => {
                handle.removeEventListener('mousedown', startResize);
            });

            // Add listeners to all resize handles
            const handles = document.querySelectorAll('.resize-handle');
            handles.forEach(handle => {
                handle.addEventListener('mousedown', startResize);
            });

            // Ensure document listeners are set (only once)
            if (!window.resizeListenersAdded) {
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                window.resizeListenersAdded = true;
            }
        }

        function startResize(e) {
            isResizing = true;
            currentColumn = e.target.parentElement;
            startX = e.pageX;
            startWidth = currentColumn.offsetWidth;

            // Find which actual column this header controls
            const table = currentColumn.closest('table');
            const colgroup = table.querySelector('colgroup');

            if (!colgroup) {
                currentColElement = null;
                e.preventDefault();
                return;
            }

            // Get all header rows
            const thead = table.querySelector('thead');
            const headerRows = Array.from(thead.querySelectorAll('tr'));
            const currentRow = currentColumn.parentElement;
            const rowIndex = headerRows.indexOf(currentRow);

            // Build a map of which columns are occupied by which cells
            // This accounts for both colspan and rowspan
            const columnOccupancy = [];

            // Process each row
            for (let r = 0; r < headerRows.length; r++) {
                if (!columnOccupancy[r]) columnOccupancy[r] = [];

                const cells = Array.from(headerRows[r].children);
                let colPos = 0;

                for (let c = 0; c < cells.length; c++) {
                    const cell = cells[c];

                    // Find next available column position
                    while (columnOccupancy[r][colPos]) {
                        colPos++;
                    }

                    const colspan = parseInt(cell.getAttribute('colspan') || '1');
                    const rowspan = parseInt(cell.getAttribute('rowspan') || '1');

                    // Mark columns as occupied by this cell
                    for (let rs = 0; rs < rowspan; rs++) {
                        if (!columnOccupancy[r + rs]) columnOccupancy[r + rs] = [];
                        for (let cs = 0; cs < colspan; cs++) {
                            columnOccupancy[r + rs][colPos + cs] = cell;
                        }
                    }

                    // If this is our target cell, remember its column position
                    if (cell === currentColumn) {
                        currentColElement = colgroup.children[colPos];
                        e.preventDefault();
                        return;
                    }

                    colPos += colspan;
                }
            }

            currentColElement = null;
            e.preventDefault();
        }

        function doResize(e) {
            if (!isResizing) return;
            const diff = e.pageX - startX;
            const newWidth = Math.max(30, startWidth + diff);

            // Update the col element in colgroup (this controls the actual column width)
            if (currentColElement) {
                currentColElement.style.width = newWidth + 'px';
            }

            // Also update the th for visual consistency
            currentColumn.style.width = newWidth + 'px';
        }

        function stopResize() {
            if (isResizing) {
                isResizing = false;
            }
        }

        // Sorting functions
        function sortResourceTable(type, column) {
            const state = sortState[type];

            // Toggle direction if same column, otherwise start with ascending
            if (state.column === column) {
                state.direction = state.direction === 'asc' ? 'desc' : 'asc';
            } else {
                state.column = column;
                state.direction = 'asc';
            }

            // Get sorted resources and save back to allResources to preserve order
            const sortedResources = getSortedResources(type, column, state.direction);
            allResources[type] = sortedResources;

            // Re-render the table with sorted data
            if (type === 'imperium') {
                initializeImperiumDetailed(sortedResources);
            } else {
                initializeTab(type);
            }
        }

        // Helper function to create gradient from a base color
        function createGradientFromColor(hexColor) {
            if (!hexColor) return 'linear-gradient(90deg, rgba(77, 148, 255, 1), rgba(128, 179, 255, 0.6))';

            // Remove # if present
            const hex = hexColor.replace('#', '');
            // Convert to RGB
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);

            // Create a lighter version (add 30 to each channel, max 255)
            const r2 = Math.min(255, r + 30);
            const g2 = Math.min(255, g + 30);
            const b2 = Math.min(255, b + 30);

            const color1 = `rgb(${r}, ${g}, ${b})`;
            const color2 = `rgb(${r2}, ${g2}, ${b2})`;

            return `linear-gradient(90deg, ${color1}, ${color2})`;
        }

        // Helper function to create bar chart HTML for statistics
        function createStatBarChart(label, count, percentage, maxCount, category = null) {
            const barWidth = maxCount > 0 ? (count / maxCount * 100) : 0;

            // Get color based on category and label
            let barColor = null;
            if (category) {
                barColor = getColorForCategory(category, label);
            }

            // Create gradient from themed color or use default
            let barStyle = '';
            if (barColor) {
                const gradient = createGradientFromColor(barColor);
                barStyle = `background: ${gradient} !important;`;
            } else {
                barStyle = `background: linear-gradient(90deg, rgba(77, 148, 255, 1), rgba(128, 179, 255, 0.6)) !important;`;
            }

            return `
                <div class="stat-bar-container">
                    <div class="stat-bar-label">${label}</div>
                    <div class="stat-bar-wrapper">
                        <div class="stat-bar" style="width: ${barWidth}%; ${barStyle}">
                            <span class="stat-bar-value" style="color: black;">${count}</span>
                        </div>
                    </div>
                    <div class="stat-bar-percentage">${percentage}%</div>
                </div>
            `;
        }

        function getSortedResources(type, column, direction) {
            // Create a copy with original indices for stable sorting
            const resources = (allResources[type] || []).map((resource, index) => ({
                ...resource,
                __originalIndex: index
            }));

            // Stable sort: preserves order of equal elements
            resources.sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle different data types
                if (aVal === undefined || aVal === null || aVal === '') aVal = '';
                if (bVal === undefined || bVal === null || bVal === '') bVal = '';

                // Try to parse as numbers
                const aNum = parseFloat(aVal);
                const bNum = parseFloat(bVal);

                let comparison = 0;

                if (!isNaN(aNum) && !isNaN(bNum)) {
                    comparison = direction === 'asc' ? aNum - bNum : bNum - aNum;
                } else {
                    // String comparison
                    const aStr = String(aVal).toLowerCase();
                    const bStr = String(bVal).toLowerCase();

                    if (direction === 'asc') {
                        comparison = aStr < bStr ? -1 : aStr > bStr ? 1 : 0;
                    } else {
                        comparison = aStr > bStr ? -1 : aStr < bStr ? 1 : 0;
                    }
                }

                // If values are equal, preserve original order (stable sort)
                if (comparison === 0) {
                    return a.__originalIndex - b.__originalIndex;
                }

                return comparison;
            });

            // Remove the temporary index property
            return resources.map(({ __originalIndex, ...resource }) => resource);
        }


        function updateImperiumStats() {
            const statsDiv = document.getElementById('imperium-stats');
            if (!statsDiv) return;

            const cards = allResources.imperium.filter(c => c.selected > 0);
            if (cards.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No cards selected</p>';
                return;
            }

            // Calculate totals considering selected count
            let totalCards = 0;
            const uniqueCards = cards.length; // Number of unique cards
            const bySets = {};
            const byCosts = {};
            const mechanics = {};
            const access = {};
            const affiliation = {};

            cards.forEach(c => {
                const count = c.selected || 0;
                const cost = parseFloat(c.cost || c.persuasion_cost || 0) || 0;

                totalCards += count;

                const set = c.source || c.card_set || 'Unknown';
                console.log(`Card: ${c.name}, source: ${c.source}, card_set: ${c.card_set}, using set: ${set}`);
                bySets[set] = (bySets[set] || 0) + count;

                // Count by cost
                const costKey = cost.toString();
                byCosts[costKey] = (byCosts[costKey] || 0) + count;

                // Count mechanics
                const mechanicFields = ['tech', 'shipping', 'unload', 'infiltration', 'research', 'grafting', 'spies', 'sandworms', 'contracts', 'sardaukar'];
                mechanicFields.forEach(field => {
                    if (c[field] && c[field] !== '0' && c[field] !== '0.0') {
                        mechanics[field] = (mechanics[field] || 0) + count;
                    }
                });

                // Count access
                const accessFields = ['green_access', 'purple_access', 'yellow_access', 'emperor_access', 'spacing_guild_access', 'bene_gesserit_access', 'fremen_access', 'spy_access'];
                accessFields.forEach(field => {
                    if (hasX(c[field])) {
                        const displayName = field.replace('_access', '').replace('_', ' ');
                        access[displayName] = (access[displayName] || 0) + count;
                    }
                });

                // Count affiliation
                const affiliationFields = ['emperor_affiliation', 'spacing_guild_affiliation', 'bene_gesserit_affiliation', 'fremen_affiliation'];
                affiliationFields.forEach(field => {
                    if (hasX(c[field])) {
                        const displayName = field.replace('_affiliation', '').replace('_', ' ');
                        affiliation[displayName] = (affiliation[displayName] || 0) + count;
                    }
                });
            });

            let html = `
                <p><strong>Total Cards:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
            `;

            // By Cost column
            html += '<div><p><strong>Cost:</strong></p>';
            const maxCostCount = Math.max(...Object.values(byCosts));
            for (const [cost, count] of Object.entries(byCosts).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(`Cost ${cost}`, count, percentage, maxCostCount, null); // Cost has no color theme
            }
            html += '</div>';

            // By Set column
            html += '<div><p><strong>Set:</strong></p>';
            const maxSetCount = Math.max(...Object.values(bySets));
            for (const [set, count] of Object.entries(bySets).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(set, count, percentage, maxSetCount, 'set');
            }
            html += '</div>';

            // Mechanics column
            if (Object.keys(mechanics).length > 0) {
                html += '<div><p><strong>Mechanics:</strong></p>';
                const maxMechCount = Math.max(...Object.values(mechanics));
                for (const [mech, count] of Object.entries(mechanics).sort((a, b) => b[1] - a[1])) {
                    const displayName = mech.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxMechCount, null); // Mechanics have no color theme
                }
                html += '</div>';
            }

            // Access column
            if (Object.keys(access).length > 0) {
                html += '<div><p><strong>Access:</strong></p>';
                const maxAccessCount = Math.max(...Object.values(access));
                for (const [acc, count] of Object.entries(access).sort((a, b) => b[1] - a[1])) {
                    const displayName = acc.replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxAccessCount, 'access');
                }
                html += '</div>';
            }

            // Affiliation column
            if (Object.keys(affiliation).length > 0) {
                html += '<div><p><strong>Affiliation:</strong></p>';
                const maxAffCount = Math.max(...Object.values(affiliation));
                for (const [aff, count] of Object.entries(affiliation).sort((a, b) => b[1] - a[1])) {
                    const displayName = aff.replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxAffCount, 'affiliation');
                }
                html += '</div>';
            }

            html += '</div>'; // Close grid container
            statsDiv.innerHTML = html;
        }

        function updateIntrigueStats() {
            const statsDiv = document.getElementById('intrigue-stats');
            if (!statsDiv) return;
            const cards = allResources.intrigue.filter(c => c.selected > 0);
            if (cards.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No cards selected</p>';
                return;
            }
            const totalCards = cards.reduce((sum, c) => sum + (c.selected || 0), 0);
            const uniqueCards = cards.length;
            const bySets = {};
            const mechanics = {};

            cards.forEach(c => {
                const count = c.selected || 0;
                const set = c.source || c.card_set || 'Unknown';
                bySets[set] = (bySets[set] || 0) + count;

                // Count mechanics
                const mechanicFields = ['tech', 'shipping', 'research', 'spies', 'sandworms', 'contracts', 'sardaukar'];
                mechanicFields.forEach(field => {
                    if (c[field] && c[field] !== '0' && c[field] !== '0.0') {
                        mechanics[field] = (mechanics[field] || 0) + count;
                    }
                });
            });

            let html = `
                <p><strong>Total Cards:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
            `;

            // By Set column
            html += '<div><p><strong>Set:</strong></p>';
            const maxSetCount = Math.max(...Object.values(bySets));
            for (const [set, count] of Object.entries(bySets).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(set, count, percentage, maxSetCount, 'set');
            }
            html += '</div>';

            // Mechanics column
            if (Object.keys(mechanics).length > 0) {
                html += '<div><p><strong>Mechanics:</strong></p>';
                const maxMechCount = Math.max(...Object.values(mechanics));
                for (const [mech, count] of Object.entries(mechanics).sort((a, b) => b[1] - a[1])) {
                    const displayName = mech.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxMechCount, null);
                }
                html += '</div>';
            }

            html += '</div>'; // Close grid container
            statsDiv.innerHTML = html;
        }

        function updateTleilaxStats() {
            const statsDiv = document.getElementById('tleilax-stats');
            if (!statsDiv) return;
            const cards = allResources.tleilax.filter(c => c.selected > 0);
            if (cards.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No cards selected</p>';
                return;
            }
            let totalCards = 0;
            const uniqueCards = cards.length;
            const byCosts = {};
            const mechanics = {};
            const access = {};

            cards.forEach(c => {
                const count = c.selected || 0;
                const cost = parseFloat(c.specimen_cost || 0) || 0;
                totalCards += count;

                // Count by cost
                const costKey = cost.toString();
                byCosts[costKey] = (byCosts[costKey] || 0) + count;

                // Count mechanics
                const mechanicFields = ['infiltration', 'research', 'grafting'];
                mechanicFields.forEach(field => {
                    if (c[field] && c[field] !== '0' && c[field] !== '0.0') {
                        mechanics[field] = (mechanics[field] || 0) + count;
                    }
                });

                // Count access
                const accessFields = ['green_access', 'purple_access', 'yellow_access', 'emperor_access', 'spacing_guild_access', 'bene_gesserit_access', 'fremen_access'];
                accessFields.forEach(field => {
                    if (hasX(c[field])) {
                        const displayName = field.replace('_access', '').replace('_', ' ');
                        access[displayName] = (access[displayName] || 0) + count;
                    }
                });
            });

            let html = `
                <p><strong>Total Cards:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
            `;

            // By Cost column
            html += '<div><p><strong>Cost:</strong></p>';
            const maxCostCount = Math.max(...Object.values(byCosts));
            for (const [cost, count] of Object.entries(byCosts).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(`Cost ${cost}`, count, percentage, maxCostCount, null);
            }
            html += '</div>';

            // Mechanics column
            if (Object.keys(mechanics).length > 0) {
                html += '<div><p><strong>Mechanics:</strong></p>';
                const maxMechCount = Math.max(...Object.values(mechanics));
                for (const [mech, count] of Object.entries(mechanics).sort((a, b) => b[1] - a[1])) {
                    const displayName = mech.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxMechCount, null);
                }
                html += '</div>';
            }

            // Access column
            if (Object.keys(access).length > 0) {
                html += '<div><p><strong>Access:</strong></p>';
                const maxAccessCount = Math.max(...Object.values(access));
                for (const [acc, count] of Object.entries(access).sort((a, b) => b[1] - a[1])) {
                    const displayName = acc.replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxAccessCount, 'access');
                }
                html += '</div>';
            }

            html += '</div>'; // Close grid container
            statsDiv.innerHTML = html;
        }

        function updateReserveStats() {
            const statsDiv = document.getElementById('reserve-stats');
            if (!statsDiv) return;
            const cards = allResources.reserve.filter(c => c.selected > 0);
            if (cards.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No cards selected</p>';
                return;
            }
            let totalCards = 0;
            const uniqueCards = cards.length;
            const byCosts = {};
            cards.forEach(c => {
                const count = c.selected || 0;
                const cost = parseFloat(c.persuasion_cost || 0) || 0;
                totalCards += count;

                // Count by cost
                const costKey = cost.toString();
                byCosts[costKey] = (byCosts[costKey] || 0) + count;
            });

            let html = `
                <p><strong>Total Cards:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
                    <div><p><strong>Cost:</strong></p>
            `;

            // Sort costs numerically
            const maxCostCount = Math.max(...Object.values(byCosts));
            for (const [cost, count] of Object.entries(byCosts).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(`Cost ${cost}`, count, percentage, maxCostCount, null);
            }
            html += '</div></div>'; // Close div and grid

            statsDiv.innerHTML = html;
        }

        function updateTechStats() {
            const statsDiv = document.getElementById('tech-stats');
            if (!statsDiv) return;
            const tiles = allResources.tech.filter(t => t.selected > 0);
            if (tiles.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No tech selected</p>';
                return;
            }

            const uniqueCards = tiles.length;
            let totalCards = 0;
            const byCosts = {};
            const bySets = {};
            const mechanics = {};
            const byVPs = {};

            tiles.forEach(t => {
                const count = t.selected || 1;
                totalCards += count;

                // Cost
                const cost = parseFloat(t.spice_cost || 0) || 0;
                const costKey = cost.toString();
                byCosts[costKey] = (byCosts[costKey] || 0) + count;

                // Set
                const set = t.source || t.card_set || 'Unknown';
                bySets[set] = (bySets[set] || 0) + count;

                // Mechanics
                const mechanicFields = ['shipping', 'spies', 'sandworms', 'contracts', 'sardaukar'];
                mechanicFields.forEach(field => {
                    if (t[field] && t[field] !== '0' && t[field] !== '0.0' && t[field].toString().trim() !== '') {
                        mechanics[field] = (mechanics[field] || 0) + count;
                    }
                });

                // VPs
                const vps = parseFloat(t.vps_available || 0);
                if (!isNaN(vps) && vps > 0) {
                    const vpsKey = vps.toString();
                    byVPs[vpsKey] = (byVPs[vpsKey] || 0) + count;
                }
            });

            let html = `
                <p><strong>Total Tech:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
            `;

            // Cost column
            html += '<div><p><strong>Cost:</strong></p>';
            const maxCostCount = Math.max(...Object.values(byCosts));
            for (const [cost, count] of Object.entries(byCosts).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(`Cost ${cost}`, count, percentage, maxCostCount, null);
            }
            html += '</div>';

            // Set column
            html += '<div><p><strong>Set:</strong></p>';
            const maxSetCount = Math.max(...Object.values(bySets));
            for (const [set, count] of Object.entries(bySets).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(set, count, percentage, maxSetCount, 'set');
            }
            html += '</div>';

            // Mechanics column
            if (Object.keys(mechanics).length > 0) {
                html += '<div><p><strong>Mechanics:</strong></p>';
                const maxMechCount = Math.max(...Object.values(mechanics));
                for (const [mech, count] of Object.entries(mechanics).sort((a, b) => b[1] - a[1])) {
                    const displayName = mech.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase());
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(displayName, count, percentage, maxMechCount, null);
                }
                html += '</div>';
            }

            // VPs column
            if (Object.keys(byVPs).length > 0) {
                html += '<div><p><strong>VPs:</strong></p>';
                const maxVPCount = Math.max(...Object.values(byVPs));
                for (const [vp, count] of Object.entries(byVPs).sort((a, b) => parseFloat(a[0]) - parseFloat(b[0]))) {
                    const percentage = ((count / totalCards) * 100).toFixed(1);
                    html += createStatBarChart(`${vp} VP`, count, percentage, maxVPCount, null);
                }
                html += '</div>';
            }

            html += '</div>'; // Close grid

            statsDiv.innerHTML = html;
        }

        function updateContractsStats() {
            const statsDiv = document.getElementById('contracts-stats');
            if (!statsDiv) return;
            const contracts = allResources.contracts.filter(c => c.selected > 0);
            if (contracts.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No contracts selected</p>';
                return;
            }

            let totalCards = 0;
            const uniqueCards = contracts.length;
            const bySets = {};

            contracts.forEach(c => {
                const count = c.selected || 1;
                totalCards += count;
                const set = c.source || c.card_set || 'Unknown';
                bySets[set] = (bySets[set] || 0) + count;
            });

            let html = `
                <p><strong>Total Contracts:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
                    <div><p><strong>Set:</strong></p>
            `;
            const maxSetCount = Math.max(...Object.values(bySets));
            for (const [set, count] of Object.entries(bySets).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(set, count, percentage, maxSetCount, 'set');
            }
            html += '</div></div>'; // Close div and grid
            statsDiv.innerHTML = html;
        }

        function updateLeaderStats() {
            const statsDiv = document.getElementById('leader-stats');
            if (!statsDiv) return;
            const leaders = allResources.leader.filter(l => l.selected > 0);
            if (leaders.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No leaders selected</p>';
                return;
            }

            const totalLeaders = leaders.length;
            const uniqueCards = leaders.length;
            const byHouse = {};
            const bySets = {};
            const byComplexity = {};

            leaders.forEach(l => {
                // House
                const house = l.house || 'Unknown';
                byHouse[house] = (byHouse[house] || 0) + 1;

                // Set
                const set = l.source || l.card_set || 'Unknown';
                bySets[set] = (bySets[set] || 0) + 1;

                // Complexity
                const complexity = l.listed_complexity_level || 'Unknown';
                if (complexity && complexity.toString().trim() !== '') {
                    byComplexity[complexity] = (byComplexity[complexity] || 0) + 1;
                }
            });

            let html = `
                <p><strong>Total Leaders:</strong> ${totalLeaders} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
            `;

            // Set column
            html += '<div><p><strong>Set:</strong></p>';
            const maxSetCount = Math.max(...Object.values(bySets));
            for (const [set, count] of Object.entries(bySets).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalLeaders) * 100).toFixed(1);
                html += createStatBarChart(set, count, percentage, maxSetCount, 'set');
            }
            html += '</div>';

            // House column
            html += '<div><p><strong>House:</strong></p>';
            const maxHouseCount = Math.max(...Object.values(byHouse));
            for (const [house, count] of Object.entries(byHouse).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalLeaders) * 100).toFixed(1);
                html += createStatBarChart(house, count, percentage, maxHouseCount, null);
            }
            html += '</div>';

            // Complexity column
            if (Object.keys(byComplexity).length > 0) {
                html += '<div><p><strong>Complexity:</strong></p>';
                const maxComplexityCount = Math.max(...Object.values(byComplexity));
                // Sort by complexity level (numerically if possible)
                const sortedComplexity = Object.entries(byComplexity).sort((a, b) => {
                    const numA = parseInt(a[0]);
                    const numB = parseInt(b[0]);
                    if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                    return a[0].localeCompare(b[0]);
                });
                for (const [complexity, count] of sortedComplexity) {
                    const percentage = ((count / totalLeaders) * 100).toFixed(1);
                    html += createStatBarChart(`Level ${complexity}`, count, percentage, maxComplexityCount, null);
                }
                html += '</div>';
            }

            html += '</div>'; // Close grid
            statsDiv.innerHTML = html;
        }

        function updateConflictStats() {
            const statsDiv = document.getElementById('conflict-stats');
            if (!statsDiv) return;
            const conflicts = allResources.conflict.filter(c => c.selected > 0);
            if (conflicts.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No conflicts selected</p>';
                return;
            }

            let totalCards = 0;
            const uniqueCards = conflicts.length;
            const byLevel = {};

            conflicts.forEach(c => {
                const count = c.selected || 1;
                totalCards += count;
                const level = c.conflict_level || 'Unknown';
                byLevel[level] = (byLevel[level] || 0) + count;
            });

            let html = `
                <p><strong>Total Conflicts:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
                    <div><p><strong>Level:</strong></p>
            `;
            // Sort by level (numerically if possible)
            const sortedLevels = Object.keys(byLevel).sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
                return a.localeCompare(b);
            });
            const maxLevelCount = Math.max(...Object.values(byLevel));
            for (const level of sortedLevels) {
                const count = byLevel[level];
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(`Level ${level}`, count, percentage, maxLevelCount, null);
            }
            html += '</div></div>'; // Close div and grid
            statsDiv.innerHTML = html;
        }

        function updateSardaukarStats() {
            const statsDiv = document.getElementById('sardaukar-stats');
            if (!statsDiv) return;
            const cards = allResources.sardaukar ? allResources.sardaukar.filter(c => c.selected > 0) : [];
            if (cards.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No sardaukar selected</p>';
                return;
            }

            let totalCards = 0;
            const uniqueCards = cards.length;
            cards.forEach(c => {
                totalCards += (c.selected || 1);
            });

            let html = `<p><strong>Total Sardaukar:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>`;
            statsDiv.innerHTML = html;
        }

        function updateStarterStats() {
            const statsDiv = document.getElementById('starter-stats');
            if (!statsDiv) return;
            const cards = allResources.starter ? allResources.starter.filter(c => c.selected > 0) : [];
            if (cards.length === 0) {
                statsDiv.innerHTML = '<p class="text-muted">No starter cards selected</p>';
                return;
            }

            let totalCards = 0;
            const uniqueCards = cards.length;
            const bySets = {};

            cards.forEach(c => {
                const count = c.selected || 1;
                totalCards += count;
                const set = c.source || c.card_set || 'Unknown';
                bySets[set] = (bySets[set] || 0) + count;
            });

            let html = `
                <p><strong>Total Starter:</strong> ${totalCards} &nbsp; <strong>Unique:</strong> ${uniqueCards}</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 8px;">
                    <div><p><strong>Set:</strong></p>
            `;
            const maxSetCount = Math.max(...Object.values(bySets));
            for (const [set, count] of Object.entries(bySets).sort((a, b) => b[1] - a[1])) {
                const percentage = ((count / totalCards) * 100).toFixed(1);
                html += createStatBarChart(set, count, percentage, maxSetCount, 'set');
            }
            html += '</div></div>'; // Close div and grid
            statsDiv.innerHTML = html;
        }

        function updateBadge(type) {
            const badge = document.getElementById(`${type}-badge`);
            if (badge) {
                // Count total selected items from the allResources array
                const count = allResources[type]
                    ? allResources[type].reduce((sum, r) => sum + (r.selected || 0), 0)
                    : 0;

                badge.textContent = count;
                badge.className = count > 0 ? 'badge bg-primary' : 'badge bg-secondary';
            }
        }

        function clearBlend() {
            if (!confirm('Clear all selected resources?')) return;

            // Clear Overview fields
            const descField = document.getElementById('overview-description');
            const rulesField = document.getElementById('overview-house-rules');
            if (descField) descField.value = '';
            if (rulesField) rulesField.value = '';

            // Reset all selected counts to 0
            for (let type in allResources) {
                allResources[type].forEach(resource => {
                    resource.selected = 0;
                });
            }

            // Reinitialize all tabs to update the display
            initializeAllTabs();

            // Update all badges and statistics
            for (let type in allResources) {
                updateBadge(type);
                updateStatsForType(type);
            }
        }
        window.clearBlend = clearBlend; // Ensure global access

        // Helper function to close modal safely without focus warnings
        function closeModal(modalId) {
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) {
                // Remove focus from any button inside the modal before closing
                const activeElement = document.activeElement;
                if (activeElement && activeElement.closest('.modal')) {
                    activeElement.blur();
                }
                modal.hide();
            }
        }

        async function saveCurrentBlend() {
            console.log('saveCurrentBlend() called');
            let blendName = document.getElementById('blendName').value.trim();
            console.log('Blend name:', blendName);

            // Remove .md extension if present since backend will add it
            if (blendName.endsWith('.md')) {
                blendName = blendName.slice(0, -3);
            }

            const resources_by_type = {};

            // Get board selections first
            const mainBoard = document.querySelector('input[name="mainBoard"]:checked')?.value || 'imperium';
            const additionalBoards = [];
            document.querySelectorAll('#board-panel input[type="checkbox"]:checked').forEach(cb => {
                additionalBoards.push(cb.value);
            });

            // Add board info to resources (will be placed at top of file)
            resources_by_type['Board'] = {
                mainBoard: mainBoard,
                additionalBoards: additionalBoards
            };

            for (let type in allResources) {
                const selectedItems = allResources[type].filter(r => r.selected > 0);
                if (selectedItems.length > 0) {
                    const typeName = type.charAt(0).toUpperCase() + type.slice(1);
                    // Expand resources based on selected count
                    const expandedResources = [];

                    // Group resources by name and source to detect synonyms
                    const nameSourceGroups = new Map();
                    selectedItems.forEach(resource => {
                        const name = resource.objective || resource.name;
                        const source = resource.source || resource.card_set || '';

                        // Always include resource_id in the key to ensure each resource is unique
                        // This is critical for resources with minimal data (e.g., Uprising Skirmish)
                        const resourceId = resource.resource_id !== undefined ? resource.resource_id : allResources[type].indexOf(resource);
                        let key = `${name}|${source}|${resourceId}`;

                        if (!nameSourceGroups.has(key)) {
                            nameSourceGroups.set(key, []);
                        }
                        nameSourceGroups.get(key).push(resource);
                    });

                    // Now group by just name+source to assign synonym IDs
                    // IMPORTANT: Use resource_id to ensure consistent synonym numbering
                    const synonymGroups = new Map();
                    nameSourceGroups.forEach((resources, key) => {
                        const name = resources[0].objective || resources[0].name;
                        const source = resources[0].source || resources[0].card_set || '';
                        const synonymKey = `${name}|${source}`;

                        if (!synonymGroups.has(synonymKey)) {
                            synonymGroups.set(synonymKey, []);
                        }
                        // Add all resources from this specific variant with their stable resource_id
                        resources.forEach(r => {
                            const resourceId = r.resource_id !== undefined ? r.resource_id : allResources[type].indexOf(r);
                            synonymGroups.get(synonymKey).push({resource: r, resourceId: resourceId});
                        });
                    });

                    // Process each synonym group and add identifiers if needed
                    synonymGroups.forEach((resourcesWithIds, synonymKey) => {
                        // Sort by resource_id to maintain consistent order
                        resourcesWithIds.sort((a, b) => a.resourceId - b.resourceId);

                        if (resourcesWithIds.length > 1) {
                            // Multiple resources with same name/source - add identifiers
                            resourcesWithIds.forEach((item, index) => {
                                const count = item.resource.selected || 1;
                                const resourceWithId = {...item.resource, synonymId: index + 1};
                                for (let i = 0; i < count; i++) {
                                    expandedResources.push(resourceWithId);
                                }
                            });
                        } else {
                            // Single resource - no identifier needed
                            const resource = resourcesWithIds[0].resource;
                            const count = resource.selected || 1;
                            for (let i = 0; i < count; i++) {
                                expandedResources.push(resource);
                            }
                        }
                    });

                    resources_by_type[typeName + ' Cards'] = expandedResources;
                }
            }

            // Save blend - downloads as file
            try {
                const result = await saveBlend(blendName, resources_by_type);
                if (result && result.success) {
                    document.getElementById('blendName').value = result.filename;
                    // Silent save - no alert
                } else {
                    alert('Failed to save blend');
                }
            } catch(err) {
                console.error('Save error:', err);
                alert('Failed to save blend: ' + err.message);
            }
        }
        window.saveCurrentBlend = saveCurrentBlend; // Ensure global access

        function showLoadDialog() {
            console.log('showLoadDialog() called');
            listBlends()
                .then(blends => {
                    const listDiv = document.getElementById('remoteBlendList');
                    if (blends.length === 0) {
                        listDiv.innerHTML = '<p class="text-muted px-3 py-2">No blend files found</p>';
                    } else {
                        listDiv.innerHTML = '';
                        blends.forEach(blend => {
                            const item = document.createElement('button');
                            item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                            item.onclick = () => {
                                loadBlendFromServer(blend.filename);
                                // Close modal after loading
                                closeModal('loadBlendModal');
                            };

                            const nameSpan = document.createElement('span');
                            nameSpan.textContent = blend.filename;
                            nameSpan.className = 'font-monospace';

                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary';
                            badge.textContent = '.md';

                            item.appendChild(nameSpan);
                            item.appendChild(badge);
                            listDiv.appendChild(item);
                        });
                    }
                    const modal = new bootstrap.Modal(document.getElementById('loadBlendModal'));
                    modal.show();
                })
                .catch(err => {
                    console.error('Error loading blend list:', err);
                    alert('Failed to load blend file list');
                });
        }
        window.showLoadDialog = showLoadDialog; // Ensure global access

        function showSaveAsDialog() {
            console.log('showSaveAsDialog() called');
            // Populate the filename field with current filename
            const currentFilename = document.getElementById('blendName').value;
            document.getElementById('saveAsFilename').value = currentFilename;

            // Show/hide server section based on server features
            const serverSection = document.getElementById('serverSaveSection');
            const saveToServerBtn = serverSection.querySelector('button[onclick="saveToServer()"]');

            if (serverFeatures.canSaveToServer) {
                serverSection.style.display = 'block';
                saveToServerBtn.disabled = false;
                saveToServerBtn.style.opacity = '1';
                saveToServerBtn.style.cursor = 'pointer';
                saveToServerBtn.title = '';

                // Load and display existing files with clickable names
                listBlends()
                    .then(blends => {
                        const listDiv = document.getElementById('saveAsFileList');
                        if (blends.length === 0) {
                            listDiv.innerHTML = '<p class="text-muted px-3 py-2 mb-0">No existing blend files</p>';
                        } else {
                            listDiv.innerHTML = '';
                            blends.forEach(blend => {
                                const item = document.createElement('div');
                                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                                item.style.cursor = 'pointer';

                                // Single click to select filename
                                item.onclick = () => {
                                    document.getElementById('saveAsFilename').value = blend.filename;
                                };

                                // Double click to save (overwrite)
                                item.ondblclick = () => {
                                    document.getElementById('saveAsFilename').value = blend.filename;
                                    saveToServer();
                                };

                                const nameSpan = document.createElement('span');
                                nameSpan.textContent = blend.filename;
                                nameSpan.className = 'font-monospace';

                                const sizeSpan = document.createElement('small');
                                sizeSpan.className = 'text-muted';
                                const sizeKB = (blend.size / 1024).toFixed(1);
                                sizeSpan.textContent = `${sizeKB} KB`;

                                item.appendChild(nameSpan);
                                item.appendChild(sizeSpan);
                                listDiv.appendChild(item);
                            });
                        }
                    })
                    .catch(err => {
                        console.error('Error loading blend list:', err);
                        const listDiv = document.getElementById('saveAsFileList');
                        listDiv.innerHTML = '<p class="text-muted px-3 py-2 mb-0">Failed to load blend files</p>';
                    });
            } else {
                serverSection.style.display = 'block';
                saveToServerBtn.disabled = true;
                saveToServerBtn.style.opacity = '0.5';
                saveToServerBtn.style.cursor = 'not-allowed';
                saveToServerBtn.title = 'Server saving unavailable (static hosting or HTTPS/CORS restriction)';

                // Show message instead of file list
                const listDiv = document.getElementById('saveAsFileList');
                listDiv.innerHTML = '<p class="text-muted px-3 py-2 mb-0">Server saving not available</p>';
            }

            const modal = new bootstrap.Modal(document.getElementById('saveAsModal'));
            modal.show();
        }
        window.showSaveAsDialog = showSaveAsDialog; // Ensure global access

        // Save to server (local development mode)
        async function saveToServer() {
            // Check if server saving is available
            if (!serverFeatures.canSaveToServer) {
                alert('Server saving is not available. Please use the Download option instead.');
                return;
            }

            let blendName = document.getElementById('saveAsFilename').value.trim();

            if (!blendName) {
                alert('Please enter a filename');
                return;
            }

            // Remove .md extension if present since backend will add it
            if (blendName.endsWith('.md')) {
                blendName = blendName.slice(0, -3);
            }

            // Get board selections first
            const mainBoard = document.querySelector('input[name="mainBoard"]:checked')?.value || 'imperium';
            const additionalBoards = [];
            document.querySelectorAll('#board-panel input[type="checkbox"]:checked').forEach(cb => {
                additionalBoards.push(cb.value);
            });

            // Get overview data
            const description = document.getElementById('overview-description')?.value.trim() || '';
            const leaderSelection = document.getElementById('overview-leader-selection')?.value.trim() || '';
            const houseRules = document.getElementById('overview-house-rules')?.value.trim() || '';

            const resources_by_type = {
                'Overview': {
                    description: description,
                    leaderSelection: leaderSelection,
                    houseRules: houseRules
                },
                'Board': {
                    mainBoard: mainBoard,
                    additionalBoards: additionalBoards
                }
            };

            // Collect selected resources from allResources
            for (let type in allResources) {
                const selectedItems = allResources[type].filter(r => r.selected > 0);
                if (selectedItems.length > 0) {
                    const typeName = type.charAt(0).toUpperCase() + type.slice(1);
                    const expandedResources = [];

                    // Group resources by name and source to detect synonyms
                    const nameSourceGroups = new Map();
                    selectedItems.forEach(resource => {
                        const name = resource.objective || resource.name;
                        const source = resource.source || resource.card_set || '';

                        // Always include resource_id in the key to ensure each resource is unique
                        // This is critical for resources with minimal data (e.g., Uprising Skirmish)
                        const resourceId = resource.resource_id !== undefined ? resource.resource_id : allResources[type].indexOf(resource);
                        let key = `${name}|${source}|${resourceId}`;

                        if (!nameSourceGroups.has(key)) {
                            nameSourceGroups.set(key, []);
                        }
                        nameSourceGroups.get(key).push(resource);
                    });

                    // Now group by just name+source to assign synonym IDs
                    const synonymGroups = new Map();
                    nameSourceGroups.forEach((resources, key) => {
                        const name = resources[0].objective || resources[0].name;
                        const source = resources[0].source || resources[0].card_set || '';
                        const synonymKey = `${name}|${source}`;

                        if (!synonymGroups.has(synonymKey)) {
                            synonymGroups.set(synonymKey, []);
                        }
                        // Add all resources from this specific variant with their stable resource_id
                        resources.forEach(r => {
                            const resourceId = r.resource_id !== undefined ? r.resource_id : allResources[type].indexOf(r);
                            synonymGroups.get(synonymKey).push({resource: r, resourceId: resourceId});
                        });
                    });

                    // Process each synonym group and add identifiers if needed
                    synonymGroups.forEach((resourcesWithIds, synonymKey) => {
                        // Sort by resource_id to maintain consistent order
                        resourcesWithIds.sort((a, b) => a.resourceId - b.resourceId);

                        if (resourcesWithIds.length > 1) {
                            // Multiple resources with same name/source - add identifiers
                            resourcesWithIds.forEach((item, index) => {
                                const count = item.resource.selected || 1;
                                const resourceWithId = {...item.resource, synonymId: index + 1};
                                for (let i = 0; i < count; i++) {
                                    expandedResources.push(resourceWithId);
                                }
                            });
                        } else {
                            // Single resource - no identifier needed
                            const resource = resourcesWithIds[0].resource;
                            const count = resource.selected || 1;
                            for (let i = 0; i < count; i++) {
                                expandedResources.push(resource);
                            }
                        }
                    });

                    resources_by_type[typeName + ' Cards'] = expandedResources;
                }
            }

            if (Object.keys(resources_by_type).length <= 1) { // Only Board or Overview
                alert('No resources selected to save!');
                return;
            }

            // Save to server
            try {
                const result = await saveBlend(blendName, resources_by_type);
                if (result && result.success) {
                    document.getElementById('blendName').value = result.filename;
                    closeModal('saveAsModal');
                    // Silent save
                } else {
                    alert('Failed to save blend to server');
                }
            } catch(err) {
                console.error('Save error:', err);
                alert('Failed to save blend: ' + err.message);
            }
        }
        window.saveToServer = saveToServer; // Ensure global access

        // Download blend as file
        async function saveAsDownload() {
            let blendName = document.getElementById('saveAsFilename').value.trim();

            if (!blendName) {
                alert('Please enter a filename');
                return;
            }

            // Remove .md extension if present since backend will add it
            if (blendName.endsWith('.md')) {
                blendName = blendName.slice(0, -3);
            }

            // Get board selections first
            const mainBoard = document.querySelector('input[name="mainBoard"]:checked')?.value || 'imperium';
            const additionalBoards = [];
            document.querySelectorAll('#board-panel input[type="checkbox"]:checked').forEach(cb => {
                additionalBoards.push(cb.value);
            });

            // Get overview data
            const description = document.getElementById('overview-description')?.value.trim() || '';
            const leaderSelection = document.getElementById('overview-leader-selection')?.value.trim() || '';
            const houseRules = document.getElementById('overview-house-rules')?.value.trim() || '';

            const resources_by_type = {
                'Overview': {
                    description: description,
                    leaderSelection: leaderSelection,
                    houseRules: houseRules
                },
                'Board': {
                    mainBoard: mainBoard,
                    additionalBoards: additionalBoards
                }
            };

            // Collect selected resources from allResources
            for (let type in allResources) {
                const selectedItems = allResources[type].filter(r => r.selected > 0);
                if (selectedItems.length > 0) {
                    const typeName = type.charAt(0).toUpperCase() + type.slice(1);
                    const expandedResources = [];

                    // Group resources by name and source to detect synonyms
                    const nameSourceGroups = new Map();
                    selectedItems.forEach(resource => {
                        const name = resource.objective || resource.name;
                        const source = resource.source || resource.card_set || '';

                        // Always include resource_id in the key to ensure each resource is unique
                        // This is critical for resources with minimal data (e.g., Uprising Skirmish)
                        const resourceId = resource.resource_id !== undefined ? resource.resource_id : allResources[type].indexOf(resource);
                        let key = `${name}|${source}|${resourceId}`;

                        if (!nameSourceGroups.has(key)) {
                            nameSourceGroups.set(key, []);
                        }
                        nameSourceGroups.get(key).push(resource);
                    });

                    // Now group by just name+source to assign synonym IDs
                    const synonymGroups = new Map();
                    nameSourceGroups.forEach((resources, key) => {
                        const name = resources[0].objective || resources[0].name;
                        const source = resources[0].source || resources[0].card_set || '';
                        const synonymKey = `${name}|${source}`;

                        if (!synonymGroups.has(synonymKey)) {
                            synonymGroups.set(synonymKey, []);
                        }
                        // Add all resources from this specific variant with their original index
                        resources.forEach(r => {
                            // Find the original index in allResources[type] array
                            const originalIndex = allResources[type].indexOf(r);
                            synonymGroups.get(synonymKey).push({resource: r, originalIndex: originalIndex});
                        });
                    });

                    // Process each synonym group and add identifiers if needed
                    synonymGroups.forEach((resourcesWithIndices, synonymKey) => {
                        // Sort by original index to maintain consistent order
                        resourcesWithIndices.sort((a, b) => a.originalIndex - b.originalIndex);

                        if (resourcesWithIndices.length > 1) {
                            // Multiple resources with same name/source - add identifiers
                            resourcesWithIndices.forEach((item, index) => {
                                const count = item.resource.selected || 1;
                                const resourceWithId = {...item.resource, synonymId: index + 1};
                                for (let i = 0; i < count; i++) {
                                    expandedResources.push(resourceWithId);
                                }
                            });
                        } else {
                            // Single resource - no identifier needed
                            const resource = resourcesWithIndices[0].resource;
                            const count = resource.selected || 1;
                            for (let i = 0; i < count; i++) {
                                expandedResources.push(resource);
                            }
                        }
                    });

                    resources_by_type[typeName + ' Cards'] = expandedResources;
                }
            }

            if (Object.keys(resources_by_type).length <= 1) { // Only Board
                alert('No resources selected to save!');
                return;
            }

            // Force download by temporarily overriding server features
            const originalFeatures = {...serverFeatures};
            serverFeatures.canSaveToServer = false;

            try {
                const result = await saveBlend(blendName, resources_by_type);
                if (result && result.success) {
                    document.getElementById('blendName').value = result.filename;
                    closeModal('saveAsModal');
                    // Silent download
                } else {
                    alert('Failed to download blend');
                }
            } catch(err) {
                console.error('Download error:', err);
                alert('Failed to download blend: ' + err.message);
            } finally {
                // Restore original features
                serverFeatures.canSaveToServer = originalFeatures.canSaveToServer;
            }
        }
        window.saveAsDownload = saveAsDownload; // Ensure global access

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.closest('#dropZone').style.backgroundColor = '#e3f2fd';
            e.target.closest('#dropZone').style.borderColor = '#2196F3';
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            e.target.closest('#dropZone').style.backgroundColor = '#f8f9fa';
            e.target.closest('#dropZone').style.borderColor = '#dee2e6';
        }

        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();

            const dropZone = e.target.closest('#dropZone');
            dropZone.style.backgroundColor = '#f8f9fa';
            dropZone.style.borderColor = '#dee2e6';

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.md')) {
                    loadBlendFromFile(file);
                } else {
                    alert('Please drop a .md file');
                }
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.md')) {
                loadBlendFromFile(file);
            }
        }

        function loadBlendFromFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                try {
                    // Use the same parsing logic as remote loading
                    const parsedData = parseBlendFile(content);

                    if (parsedData && parsedData.success) {
                        // Use the same loading logic as loadBlendFromServer
                        loadParsedBlendData(parsedData, file.name);

                        // Close modal
                        closeModal('loadBlendModal');

                        console.log(`âœ… Loaded local blend: ${file.name}`);
                    } else {
                        throw new Error('Failed to parse blend file');
                    }
                } catch (error) {
                    console.error('Error loading local blend:', error);
                    alert(`Failed to load blend file: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }


        // Shared function to load parsed blend data (used by both remote and local loading)
        function loadParsedBlendData(data, filename) {
            if (!data || !data.success) {
                throw new Error('Invalid blend data');
            }

            // Clear Overview fields first (in case file has no Overview section)
            const descField = document.getElementById('overview-description');
            const leaderField = document.getElementById('overview-leader-selection');
            const rulesField = document.getElementById('overview-house-rules');
            if (descField) descField.value = '';
            if (leaderField) leaderField.value = '';
            if (rulesField) rulesField.value = '';

            // Clear current selection
            for (let type in selectedResources) {
                selectedResources[type] = [];
            }

            // Reset all selected counts to 0 in allResources AND update UI
            for (let type in allResources) {
                if (allResources[type] && Array.isArray(allResources[type])) {
                    allResources[type].forEach(resource => {
                        resource.selected = 0;
                    });
                    // Update UI immediately after clearing to reflect the empty state
                    try {
                        initializeTab(type);
                        updateBadge(type);
                        updateStatsForType(type);
                    } catch (error) {
                        console.error(`Error clearing UI for ${type}:`, error);
                    }
                }
            }

            // Match and load resources
            const resources = data.resources;
            for (let sectionName in resources) {
                const resourceNames = resources[sectionName];

                // Handle Overview section specially
                if (sectionName === 'Overview') {
                    const overviewData = resourceNames;
                    // Clear all overview fields first
                    const descField = document.getElementById('overview-description');
                    const leaderField = document.getElementById('overview-leader-selection');
                    const rulesField = document.getElementById('overview-house-rules');

                    if (descField) {
                        descField.value = overviewData.description || '';
                        autoResizeTextarea(descField);
                    }
                    if (leaderField) {
                        leaderField.value = overviewData.leaderSelection || '';
                        autoResizeTextarea(leaderField);
                    }
                    if (rulesField) {
                        rulesField.value = overviewData.houseRules || '';
                        autoResizeTextarea(rulesField);
                    }
                    continue;
                }

                // Handle Board section specially
                if (sectionName === 'Board') {
                    const boardData = resourceNames;
                    if (boardData.mainBoard) {
                        const mainRadio = document.querySelector(`input[name="mainBoard"][value="${boardData.mainBoard}"]`);
                        if (mainRadio) mainRadio.checked = true;
                    }
                    if (boardData.additionalBoards && Array.isArray(boardData.additionalBoards)) {
                        // Clear all checkboxes first
                        document.querySelectorAll('#board-panel input[type="checkbox"]').forEach(cb => cb.checked = false);
                        // Check the saved ones
                        boardData.additionalBoards.forEach(boardValue => {
                            const checkbox = document.querySelector(`#board-panel input[type="checkbox"][value="${boardValue}"]`);
                            if (checkbox) checkbox.checked = true;
                        });
                    }
                    continue;
                }

                const type = detectResourceType(sectionName);

                if (type && allResources[type]) {
                    // Build a map to count occurrences and track synonym IDs
                    const resourceMap = new Map();

                    resourceNames.forEach(item => {
                        // item is now {name: "...", count: X}
                        const name = item.name;
                        const desiredCount = item.count || 1;

                        // Parse name, source, and synonym ID from formats:
                        // "Name #X (Source)" or "Name (Source)"
                        let baseName = name;
                        let sourceFilter = null;
                        let synonymId = null;

                        // First, extract synonym ID if present (e.g., "Arakeen #2 (Uprising)")
                        const synonymMatch = name.match(/^(.+?)\s+#(\d+)\s*\(([^)]+)\)$/);
                        if (synonymMatch) {
                            baseName = synonymMatch[1].trim();
                            synonymId = parseInt(synonymMatch[2]);
                            sourceFilter = synonymMatch[3].trim();
                        } else {
                            // Extract (Source) suffix if present (no synonym ID)
                            const sourceMatch = name.match(/^(.+?)\s*\(([^)]+)\)$/);
                            if (sourceMatch) {
                                baseName = sourceMatch[1].trim();
                                sourceFilter = sourceMatch[2].trim();
                            }
                        }

                        // Find matching resource(s) by name AND source
                        const matchingResources = allResources[type].filter(r => {
                            const nameMatch = (r.name && r.name === baseName) ||
                                            (r.objective && r.objective === baseName);

                            // If no sourceFilter provided, match any source
                            if (!sourceFilter) {
                                return nameMatch;
                            }

                            // Check if source matches
                            const resourceSource = r.source || r.card_set || '';
                            return nameMatch && resourceSource === sourceFilter;
                        });

                        if (matchingResources.length > 0) {
                            // If synonym ID specified, find exact match using resource_id
                            let targetResource = null;
                            if (synonymId !== null && matchingResources.length >= synonymId) {
                                // Sort matching resources by resource_id to get consistent ordering
                                matchingResources.sort((a, b) => {
                                    const idA = a.resource_id !== undefined ? a.resource_id : 0;
                                    const idB = b.resource_id !== undefined ? b.resource_id : 0;
                                    return idA - idB;
                                });
                                // Now get the resource at the synonym index
                                targetResource = matchingResources[synonymId - 1];
                            } else {
                                // Use first match (also sorted by resource_id if available)
                                if (matchingResources[0].resource_id !== undefined) {
                                    matchingResources.sort((a, b) => {
                                        const idA = a.resource_id !== undefined ? a.resource_id : 0;
                                        const idB = b.resource_id !== undefined ? b.resource_id : 0;
                                        return idA - idB;
                                    });
                                }
                                targetResource = matchingResources[0];
                            }

                            if (targetResource) {
                                // Increment selected count
                                targetResource.selected = (targetResource.selected || 0) + desiredCount;
                            }
                        }
                    });

                    // Update UI for this resource type
                    try {
                        initializeTab(type);
                        updateBadge(type);
                    } catch (error) {
                        console.error(`Error updating UI for ${type}:`, error);
                    }

                    // Update statistics
                    try {
                        updateStatsForType(type);
                    } catch (error) {
                        console.error(`Error updating stats for ${type}:`, error);
                    }
                }
            }

            // Update the filename field with the loaded blend's filename
            document.getElementById('blendName').value = filename;

            // Update required sets display (in case Board tab is currently open)
            updateRequiredSets();

            // Deferred resize of Overview textareas (in case tab was hidden during load)
            setTimeout(() => {
                const descField = document.getElementById('overview-description');
                const leaderField = document.getElementById('overview-leader-selection');
                const rulesField = document.getElementById('overview-house-rules');
                if (descField) autoResizeTextarea(descField);
                if (leaderField) autoResizeTextarea(leaderField);
                if (rulesField) autoResizeTextarea(rulesField);
            }, 100);
        }

        function loadBlendFromServer(filename) {
            loadBlend(filename)
                .then(data => {
                    try {
                        loadParsedBlendData(data, filename);

                        // Close the modal
                        closeModal('loadBlendModal');

                        console.log(`âœ… Loaded remote blend: ${filename}`);
                    } catch (error) {
                        console.error('Load error:', error);
                        alert(`Failed to load blend: ${error.message}`);
                    }
                })
                .catch(err => {
                    console.error('Load error:', err);
                    alert('Failed to load blend: ' + err.message);
                });
        }


        function detectResourceType(sectionName) {
            const lower = sectionName.toLowerCase();
            if (lower.includes('imperium')) return 'imperium';
            if (lower.includes('intrigue')) return 'intrigue';
            if (lower.includes('tleilax')) return 'tleilax';
            if (lower.includes('reserve')) return 'reserve';
            if (lower.includes('tech')) return 'tech';
            if (lower.includes('contract')) return 'contracts';
            if (lower.includes('leader')) return 'leader';
            if (lower.includes('sardaukar')) return 'sardaukar';
            if (lower.includes('starter')) return 'starter';
            if (lower.includes('conflict')) return 'conflict';
            return null;
        }

        // ========================================
        // Photo Scanning with image AI (Gemini Flash 2.5)
        // ========================================

        let geminiApiKey = localStorage.getItem('geminiApiKey') || '';
        let geminiModel = localStorage.getItem('geminiModel') || 'gemini-2.5-flash';
        let detectedCardsGlobal = [];
        let currentResourceType = 'imperium'; // Track which resource type we're scanning

        function showPhotoScanDialog(resourceType = 'imperium') {
            // Check if API key is set
            if (!geminiApiKey) {
                showApiKeyDialog();
                return;
            }

            // Store the resource type
            currentResourceType = resourceType;

            // DON'T reset dialog - preserve previous scan results
            // Only reset when modal is closed or new input is provided

            // Update resource type selector dropdown
            const resourceTypeSelect = document.getElementById('scanResourceTypeSelect');
            if (resourceTypeSelect) {
                resourceTypeSelect.value = resourceType;
            }

            // Update dialog title and text based on resource type
            const resourceNames = {
                'imperium': 'Imperium Cards',
                'intrigue': 'Intrigue Cards',
                'tleilax': 'Tleilax Cards',
                'reserve': 'Reserve Cards',
                'tech': 'Tech Tiles',
                'contracts': 'Contracts',
                'leader': 'Leaders',
                'sardaukar': 'Sardaukar',
                'starter': 'Starter Cards',
                'conflict': 'Conflict Cards'
            };

            document.getElementById('resourceTypeName').textContent = resourceNames[resourceType] || 'resources';

            // Update current model display
            const modelDisplayName = geminiModel === 'gemini-2.5-flash-lite' ? 'gemini-2.5-flash-lite' : 'gemini-2.5-flash';
            document.getElementById('currentModelDisplay').textContent = modelDisplayName;

            // Show modal - reuse existing instance if available
            const modalElement = document.getElementById('photoScanModal');
            let modal = bootstrap.Modal.getInstance(modalElement);
            if (!modal) {
                modal = new bootstrap.Modal(modalElement);
            }
            modal.show();
        }
        window.showPhotoScanDialog = showPhotoScanDialog;

        function changeScanResourceType() {
            const resourceTypeSelect = document.getElementById('scanResourceTypeSelect');
            if (resourceTypeSelect) {
                currentResourceType = resourceTypeSelect.value;

                // Update the description text
                const resourceNames = {
                    'imperium': 'Imperium Cards',
                    'intrigue': 'Intrigue Cards',
                    'tleilax': 'Tleilax Cards',
                    'reserve': 'Reserve Cards',
                    'tech': 'Tech Tiles',
                    'contracts': 'Contracts',
                    'leader': 'Leaders',
                    'sardaukar': 'Sardaukar',
                    'starter': 'Starter Cards',
                    'conflict': 'Conflict Cards'
                };

                document.getElementById('resourceTypeName').textContent = resourceNames[currentResourceType] || 'resources';
            }
        }
        window.changeScanResourceType = changeScanResourceType;

        let cameraStream = null; // Store camera stream for cleanup

        function resetScanResults() {
            // Reset status
            document.getElementById('scanStatus').innerHTML = '<p class="text-muted mb-0"><em>Processing...</em></p>';

            // Hide preview
            document.getElementById('photoPreviewContainer').style.display = 'none';

            // Hide results
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('detectedCardsList').innerHTML = '';

            // Clear detected cards
            detectedCardsGlobal = [];
        }

        function resetPhotoScanDialog() {
            // Clear file input
            const photoInput = document.getElementById('photoInput');
            if (photoInput) photoInput.value = '';

            // Stop camera if active
            stopCamera();

            // Clear clipboard state
            clipboardImageBlob = null;
            const clipboardImg = document.getElementById('clipboardImage');
            if (clipboardImg) clipboardImg.src = '';
            const clipboardInstructions = document.getElementById('clipboardInstructions');
            const clipboardPreview = document.getElementById('clipboardPreview');
            if (clipboardInstructions) clipboardInstructions.style.display = 'block';
            if (clipboardPreview) clipboardPreview.style.display = 'none';

            // Reset to file input method
            document.getElementById('inputMethodFile').checked = true;
            document.getElementById('fileInputContainer').style.display = 'block';
            document.getElementById('cameraInputContainer').style.display = 'none';
            document.getElementById('clipboardInputContainer').style.display = 'none';

            // Reset status
            document.getElementById('scanStatus').innerHTML = '<p class="text-muted mb-0"><em>Ready to scan. Upload a photo to begin.</em></p>';

            // Hide preview
            document.getElementById('photoPreviewContainer').style.display = 'none';

            // Hide results
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('detectedCardsList').innerHTML = '';

            // Clear detected cards
            detectedCardsGlobal = [];
        }

        function switchInputMethod(method) {
            if (method === 'file') {
                document.getElementById('fileInputContainer').style.display = 'block';
                document.getElementById('cameraInputContainer').style.display = 'none';
                document.getElementById('clipboardInputContainer').style.display = 'none';
                stopCamera();
            } else if (method === 'camera') {
                document.getElementById('fileInputContainer').style.display = 'none';
                document.getElementById('cameraInputContainer').style.display = 'block';
                document.getElementById('clipboardInputContainer').style.display = 'none';
                stopCamera();
            } else if (method === 'clipboard') {
                document.getElementById('fileInputContainer').style.display = 'none';
                document.getElementById('cameraInputContainer').style.display = 'none';
                document.getElementById('clipboardInputContainer').style.display = 'block';
                stopCamera();
                // Focus on clipboard area to enable paste
                setTimeout(() => {
                    document.getElementById('clipboardDropArea').focus();
                }, 100);
            }
        }
        window.switchInputMethod = switchInputMethod;

        async function startCamera() {
            const video = document.getElementById('cameraPreview');
            const startBtn = document.getElementById('startCameraBtn');
            const captureBtn = document.getElementById('capturePhotoBtn');

            try {
                // Try with environment (back) camera first
                let constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };

                try {
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                } catch (firstError) {
                    console.log('Back camera failed, trying any camera:', firstError);
                    // If back camera fails, try any available camera
                    constraints = { video: true };
                    cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                }

                video.srcObject = cameraStream;
                video.style.display = 'block';
                startBtn.style.display = 'none';
                captureBtn.style.display = 'block';
            } catch (error) {
                console.error('Error accessing camera:', error);

                let errorMessage = 'Could not access camera.\n\n';

                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage += 'Camera permission was denied. Please:\n' +
                                  '1. Check your browser settings\n' +
                                  '2. Allow camera access for this site\n' +
                                  '3. Try refreshing the page';
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage += 'No camera found on this device.\n' +
                                  'Please use "Upload File" or "Paste Image" instead.';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage += 'Camera is already in use by another application.\n' +
                                  'Please close other apps using the camera and try again.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Camera access requires HTTPS.\n' +
                                  'Please use "Upload File" or "Paste Image" instead.';
                } else {
                    errorMessage += 'Error: ' + error.message + '\n\n' +
                                  'Please try:\n' +
                                  'â€¢ Using "Upload File" instead\n' +
                                  'â€¢ Checking camera permissions\n' +
                                  'â€¢ Reloading the page';
                }

                alert(errorMessage);
            }
        }
        window.startCamera = startCamera;

        function capturePhoto() {
            const video = document.getElementById('cameraPreview');
            const canvas = document.getElementById('cameraCanvas');
            const captureBtn = document.getElementById('capturePhotoBtn');
            const retakeBtn = document.getElementById('retakePhotoBtn');

            // Set canvas size to match video
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Draw video frame to canvas
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            // Convert canvas to blob and process
            canvas.toBlob(async (blob) => {
                if (blob) {
                    // Create a File object from the blob
                    const file = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });

                    // Stop camera stream
                    stopCamera();
                    video.style.display = 'none';
                    captureBtn.style.display = 'none';
                    retakeBtn.style.display = 'block';

                    // Reset previous scan results when new photo is captured
                    resetScanResults();

                    // Process the captured photo
                    await processPhotoForCards(file);
                }
            }, 'image/jpeg', 0.9);
        }
        window.capturePhoto = capturePhoto;

        function retakePhoto() {
            const startBtn = document.getElementById('startCameraBtn');
            const retakeBtn = document.getElementById('retakePhotoBtn');

            retakeBtn.style.display = 'none';
            startBtn.style.display = 'block';

            // Reset preview and results
            document.getElementById('photoPreviewContainer').style.display = 'none';
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('scanStatus').innerHTML = '<p class="text-muted mb-0"><em>Ready to scan. Take a photo to begin.</em></p>';
        }
        window.retakePhoto = retakePhoto;

        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const video = document.getElementById('cameraPreview');
            if (video) {
                video.srcObject = null;
                video.style.display = 'none';
            }

            const startBtn = document.getElementById('startCameraBtn');
            const captureBtn = document.getElementById('capturePhotoBtn');
            const retakeBtn = document.getElementById('retakePhotoBtn');

            if (startBtn) startBtn.style.display = 'block';
            if (captureBtn) captureBtn.style.display = 'none';
            if (retakeBtn) retakeBtn.style.display = 'none';
        }

        // ========================================
        // Clipboard Paste Handling
        // ========================================

        let clipboardImageBlob = null;

        // Add paste event listener to the modal
        document.addEventListener('DOMContentLoaded', () => {
            // ...existing code...

            // Listen for paste events globally when clipboard mode is active
            document.addEventListener('paste', (e) => {
                // Only handle paste if clipboard input container is visible
                const clipboardContainer = document.getElementById('clipboardInputContainer');
                if (clipboardContainer && clipboardContainer.style.display !== 'none') {
                    handlePaste(e);
                }
            });

            // Also add click event to clipboard area for focus
            const clipboardArea = document.getElementById('clipboardDropArea');
            if (clipboardArea) {
                clipboardArea.addEventListener('click', () => {
                    clipboardArea.focus();
                });
            }
        });

        function handlePaste(e) {
            e.preventDefault();

            const items = e.clipboardData.items;
            let imageFound = false;

            for (let i = 0; i < items.length; i++) {
                const item = items[i];

                // Check if the item is an image
                if (item.type.indexOf('image') !== -1) {
                    imageFound = true;
                    const blob = item.getAsFile();

                    if (blob) {
                        clipboardImageBlob = blob;

                        // Show preview
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const img = document.getElementById('clipboardImage');
                            img.src = event.target.result;
                            document.getElementById('clipboardInstructions').style.display = 'none';
                            document.getElementById('clipboardPreview').style.display = 'block';
                        };
                        reader.readAsDataURL(blob);
                    }
                    break;
                }
            }

            if (!imageFound) {
                alert('No image found in clipboard. Please copy an image first.');
            }
        }

        function processClipboardImage() {
            if (!clipboardImageBlob) {
                alert('No image to process');
                return;
            }

            // Hide the clipboard preview area (image will show in main preview)
            document.getElementById('clipboardPreview').style.display = 'none';
            document.getElementById('clipboardInstructions').style.display = 'block';

            // Create a File object from the blob
            const file = new File([clipboardImageBlob], 'clipboard-image.png', {
                type: clipboardImageBlob.type
            });

            // Reset previous scan results when new clipboard image is processed
            resetScanResults();

            // Process the image
            processPhotoForCards(file);
        }
        window.processClipboardImage = processClipboardImage;

        function clearClipboardImage() {
            clipboardImageBlob = null;
            document.getElementById('clipboardImage').src = '';
            document.getElementById('clipboardInstructions').style.display = 'block';
            document.getElementById('clipboardPreview').style.display = 'none';

            // Hide preview and results
            document.getElementById('photoPreviewContainer').style.display = 'none';
            document.getElementById('scanResults').style.display = 'none';
            document.getElementById('scanStatus').innerHTML = '<p class="text-muted mb-0"><em>Ready to scan. Paste an image to begin.</em></p>';
        }
        window.clearClipboardImage = clearClipboardImage;

        function showApiKeyDialog() {
            // Check if photo scan modal is open
            const photoScanModalEl = document.getElementById('photoScanModal');
            const photoScanModal = bootstrap.Modal.getInstance(photoScanModalEl);

            // Close photo scan modal first if it's open
            if (photoScanModal) {
                photoScanModal.hide();
            }

            // Wait a bit for the photo scan modal to close, then open API key modal
            setTimeout(() => {
                const apiKeyModal = new bootstrap.Modal(document.getElementById('apiKeyModal'));
                document.getElementById('geminiApiKeyInput').value = geminiApiKey;
                document.getElementById('geminiModelSelect').value = geminiModel;
                apiKeyModal.show();
            }, photoScanModal ? 300 : 0); // Wait for transition if modal was open
        }

        function saveApiKey() {
            const apiKey = document.getElementById('geminiApiKeyInput').value.trim();
            const model = document.getElementById('geminiModelSelect').value;

            if (apiKey) {
                // Validate API key format (should start with AIza)
                if (!apiKey.startsWith('AIza')) {
                    alert('Invalid API key format. image AI API keys should start with "AIza".\n\nGet your API key from: https://aistudio.google.com/app/apikey');
                    return;
                }
                geminiApiKey = apiKey;
                geminiModel = model;
                localStorage.setItem('geminiApiKey', apiKey);
                localStorage.setItem('geminiModel', model);

                // Close API key modal
                const apiKeyModalEl = document.getElementById('apiKeyModal');
                const apiKeyModal = bootstrap.Modal.getInstance(apiKeyModalEl);
                if (apiKeyModal) {
                    apiKeyModal.hide();
                }

                // Wait for modal to close, then reopen photo scan dialog
                setTimeout(() => {
                    showPhotoScanDialog(currentResourceType);
                }, 300);
            } else {
                alert('Please enter a valid API key');
            }
        }
        window.saveApiKey = saveApiKey;

        // Handle photo upload
        document.addEventListener('DOMContentLoaded', () => {
            const photoInput = document.getElementById('photoInput');
            if (photoInput) {
                photoInput.addEventListener('change', async (e) => {
                    if (e.target.files[0]) {
                        // Reset previous scan results when new file is selected
                        resetScanResults();
                        await processPhotoForCards(e.target.files[0]);
                    }
                });
            }

            // DON'T reset dialog when closed - preserve scan results
            // User can reopen and continue adding/removing resources
            // Results only reset when new input is provided
            const photoScanModal = document.getElementById('photoScanModal');
            // if (photoScanModal) {
            //     photoScanModal.addEventListener('hidden.bs.modal', () => {
            //         resetPhotoScanDialog();
            //     });
            // }
        });

        async function processPhotoForCards(file) {
            if (!geminiApiKey) {
                alert('Please set your image AI API key first');
                closeModal('photoScanModal');
                showApiKeyDialog();
                return;
            }

            const statusEl = document.getElementById('scanStatus');
            const previewContainer = document.getElementById('photoPreviewContainer');
            const previewImg = document.getElementById('photoPreview');
            const resultsDiv = document.getElementById('scanResults');

            statusEl.innerHTML = '<p class="text-info"><strong>Processing image with image AI...</strong></p>';
            resultsDiv.style.display = 'none';

            try {
                // Show preview
                const imageUrl = URL.createObjectURL(file);
                previewImg.src = imageUrl;
                previewContainer.style.display = 'block';

                // Convert image to base64
                const imageBase64 = await fileToBase64(file);

                // Get resources for the current type
                const resources = allResources[currentResourceType] || [];

                // Get unique resource names based on type
                const resourceNames = resources.map(r => {
                    // Different resource types have different name fields
                    if (currentResourceType === 'conflict') {
                        return r.name; // Conflict cards use 'name'
                    } else if (currentResourceType === 'contracts') {
                        return r.objective; // Contracts use 'objective'
                    } else {
                        return r.name; // Most use 'name'
                    }
                }).filter(n => n);

                if (resourceNames.length === 0) {
                    const typeDisplayName = document.getElementById('resourceTypeName').textContent;
                    statusEl.innerHTML = `<p class="text-danger">No ${typeDisplayName} loaded</p>`;
                    return;
                }

                // Create simplified schema - just array of strings (no large enum)
                const schema = {
                    type: "array",
                    items: {
                        type: "string",
                        description: "Resource name detected in the image"
                    },
                    description: `List of all ${currentResourceType} resource names visible in the image`
                };

                statusEl.innerHTML = '<p class="text-info"><strong>Analyzing with image AI...</strong></p>';

                // Call image AI API
                const detectedNames = await callGeminiVision(imageBase64, resourceNames, schema);

                if (detectedNames && detectedNames.length > 0) {
                    // Match detected names to resources with fuzzy matching
                    const matchedCards = [];
                    const usedResources = new Set();

                    detectedNames.forEach(detectedName => {
                        // Find best match in resources
                        let bestMatch = null;
                        let bestScore = 0;

                        resources.forEach(resource => {
                            // Get the name field based on resource type
                            let resourceName;
                            if (currentResourceType === 'contracts') {
                                resourceName = resource.objective;
                            } else {
                                resourceName = resource.name;
                            }

                            if (!resourceName) return;

                            const key = `${currentResourceType}:${resourceName}`;
                            if (usedResources.has(key)) return;

                            // Calculate match score
                            const nameLower = resourceName.toLowerCase();
                            const detectedLower = detectedName.toLowerCase();

                            // Exact match
                            if (nameLower === detectedLower) {
                                bestMatch = resource;
                                bestScore = 100;
                                return;
                            }

                            // Contains match
                            if (nameLower.includes(detectedLower) || detectedLower.includes(nameLower)) {
                                const score = Math.max(detectedLower.length / nameLower.length, nameLower.length / detectedLower.length) * 90;
                                if (score > bestScore) {
                                    bestMatch = resource;
                                    bestScore = score;
                                }
                            }

                            // Word-by-word match
                            const nameWords = nameLower.split(/\s+/);
                            const detectedWords = detectedLower.split(/\s+/);
                            const matchingWords = nameWords.filter(w => detectedWords.some(d => d.includes(w) || w.includes(d)));
                            const wordScore = (matchingWords.length / Math.max(nameWords.length, detectedWords.length)) * 80;
                            if (wordScore > bestScore && wordScore > 50) {
                                bestMatch = resource;
                                bestScore = wordScore;
                            }
                        });

                        if (bestMatch && bestScore > 60) {
                            // Get resource name for the key
                            const resourceName = currentResourceType === 'contracts' ? bestMatch.objective : bestMatch.name;
                            const key = `${currentResourceType}:${resourceName}`;
                            usedResources.add(key);

                            // Calculate confidence based on score
                            const confidence = bestScore >= 90 ? 'high' : bestScore >= 75 ? 'medium' : 'low';

                            matchedCards.push({
                                type: currentResourceType,
                                resource: bestMatch,
                                detectedAs: detectedName,
                                confidence: confidence,
                                checked: true  // Default to checked
                            });
                        }
                    });

                    if (matchedCards.length > 0) {
                        // Store matched cards globally and set all to checked by default
                        detectedCardsGlobal = matchedCards;


                        // Render the list with checkboxes
                        renderDetectedCardsList();

                        resultsDiv.style.display = 'block';
                        statusEl.innerHTML = `<p class="text-success"><strong>âœ… Found ${matchedCards.length} resource(s)!</strong></p>`;
                    } else {
                        statusEl.innerHTML = '<p class="text-warning">Cards detected but could not match to database</p>';
                    }
                } else {
                    statusEl.innerHTML = '<p class="text-warning">No cards detected in image</p>';
                }

                URL.revokeObjectURL(imageUrl);
            } catch (error) {
                console.error('Error:', error);
                if (error.message.includes('API key')) {
                    statusEl.innerHTML = `<p class="text-danger"><strong>API Key Error:</strong> ${error.message}<br><button class="btn btn-sm btn-primary mt-2" onclick="showApiKeyDialog()">Update API Key</button></p>`;
                } else {
                    statusEl.innerHTML = `<p class="text-danger"><strong>Error:</strong> ${error.message}</p>`;
                }
            }
        }

        async function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function callGeminiVision(imageBase64, cardNames, schema) {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${geminiApiKey}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: imageBase64
                                }
                            },
                            {
                                text: `Identify ALL Dune Imperium resource names visible in this image. Look carefully at each resource and extract the exact name as it appears. Return a JSON array with each detected resource name. Valid resource names are: ${cardNames.slice(0, 100).join(', ')}${cardNames.length > 100 ? ', and more...' : ''}`
                            }
                        ]
                    }],
                    generationConfig: {
                        response_mime_type: "application/json",
                        response_schema: schema
                    }
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API request failed: ${response.status}`);
            }

            const data = await response.json();
            const textResponse = data.candidates?.[0]?.content?.parts?.[0]?.text;

            if (!textResponse) {
                throw new Error('No response from image AI API');
            }

            return JSON.parse(textResponse);
        }

        function updateResourceTypeFilter() {
            renderDetectedCardsList();
        }
        window.updateResourceTypeFilter = updateResourceTypeFilter;

        function renderDetectedCardsList() {
            // Display all detected cards (no filtering needed since resource type is already known)
            const listHtml = detectedCardsGlobal.map((card, index) => {
                // Get name based on resource type
                const name = card.type === 'contracts' ? card.resource.objective : card.resource.name;
                const source = card.resource.source || card.resource.card_set || '';
                const confidenceBadge = card.confidence === 'high' ? 'success' :
                                       card.confidence === 'medium' ? 'warning' : 'secondary';

                // Check if this card is already selected in the checkbox state (default to true)
                const isChecked = card.checked !== false; // Default to checked unless explicitly set to false

                return `
                    <div class="list-group-item d-flex align-items-center">
                        <input type="checkbox" class="form-check-input me-3" id="detectedCard_${index}"
                               ${isChecked ? 'checked' : ''}
                               onchange="toggleDetectedCard(${index})">
                        <label class="flex-grow-1" for="detectedCard_${index}" style="cursor: pointer;">
                            <strong>${name}</strong>
                            ${source ? `<span class="badge bg-secondary ms-2">${source}</span>` : ''}
                            <span class="badge bg-${confidenceBadge} ms-2">${card.confidence}</span>
                            <br>
                            <small class="text-muted">Detected: "${card.detectedAs}"</small>
                        </label>
                    </div>
                `;
            }).join('');

            document.getElementById('detectedCardsList').innerHTML = listHtml || '<p class="text-muted">No resources detected</p>';
        }

        function toggleDetectedCard(index) {
            if (detectedCardsGlobal[index]) {
                detectedCardsGlobal[index].checked = !detectedCardsGlobal[index].checked;
            }
        }
        window.toggleDetectedCard = toggleDetectedCard;

        function addSelectedDetectedResources() {
            const selectedCards = detectedCardsGlobal.filter(card => card.checked);

            if (selectedCards.length === 0) {
                alert('No resources selected. Check the boxes next to resources you want to add.');
                return;
            }

            // Add selected resources to their respective types
            const addedByType = {};
            const skippedResources = [];

            selectedCards.forEach(card => {
                const resource = card.resource;
                const type = card.type;

                // Check Count limit (or count_per_player for starter cards)
                const maxCount = resource.count || resource.count_per_player || 999;
                const currentSelected = resource.selected || 0;

                if (currentSelected >= maxCount) {
                    // Already at maximum count, skip this resource
                    const resourceName = type === 'contracts' ? resource.objective : resource.name;
                    skippedResources.push(`${resourceName} (already at max ${maxCount})`);
                    return;
                }

                // Increment selected count (respecting max limit)
                resource.selected = currentSelected + 1;

                // Track how many added per type
                addedByType[type] = (addedByType[type] || 0) + 1;
            });

            // Update all affected tabs
            Object.keys(addedByType).forEach(type => {
                try {
                    initializeTab(type);
                    updateBadge(type);
                    updateStatsForType(type);
                } catch (error) {
                    console.error(`Error updating ${type} tab:`, error);
                }
            });

            // DON'T close modal or clear results - user may want to add/remove more
            // Modal stays open with same scan results for further operations

            const totalAdded = Object.values(addedByType).reduce((sum, count) => sum + count, 0);
            console.log(`âœ… Added ${totalAdded} resource(s) to blend`);

            // Log skipped resources to console (no popup)
            if (skippedResources.length > 0) {
                console.log(`âš ï¸ Skipped ${skippedResources.length} resource(s) already at max count:`, skippedResources);
            }
        }
        window.addSelectedDetectedResources = addSelectedDetectedResources;

        function removeSelectedDetectedResources() {
            const selectedCards = detectedCardsGlobal.filter(card => card.checked);

            if (selectedCards.length === 0) {
                alert('No resources selected. Check the boxes next to resources you want to remove.');
                return;
            }

            // Remove selected resources from their respective types
            const removedByType = {};

            selectedCards.forEach(card => {
                const resource = card.resource;
                const type = card.type;

                // Decrement selected count (don't go below 0)
                if (resource.selected && resource.selected > 0) {
                    resource.selected = resource.selected - 1;
                    removedByType[type] = (removedByType[type] || 0) + 1;
                }
            });

            // Update all affected tabs
            Object.keys(removedByType).forEach(type => {
                try {
                    initializeTab(type);
                    updateBadge(type);
                    updateStatsForType(type);
                } catch (error) {
                    console.error(`Error updating ${type} tab:`, error);
                }
            });

            // DON'T close modal or clear results - user may want to add/remove more
            // Modal stays open with same scan results for further operations

            console.log(`âœ… Removed ${selectedCards.length} resource(s) from blend`);
        }
        window.removeSelectedDetectedResources = removeSelectedDetectedResources;

        function applyDetectedCards() {
            // Legacy function - redirect to new function
            // Select all cards first
            detectedCardsGlobal.forEach(card => card.checked = true);
            addSelectedDetectedResources();
        }
        window.applyDetectedCards = applyDetectedCards;

        // Table resize functionality
        document.addEventListener('DOMContentLoaded', () => {
            // Find all table-responsive divs and add resize handles
            const tableContainers = document.querySelectorAll('.table-responsive');

            tableContainers.forEach((container, index) => {
                // Skip if already has resize handle
                if (container.nextElementSibling && container.nextElementSibling.classList.contains('table-resize-handle')) {
                    return;
                }

                // Create resize handle
                const handle = document.createElement('div');
                handle.className = 'table-resize-handle';
                handle.setAttribute('data-table-index', index);

                // Insert after the container
                container.parentNode.insertBefore(handle, container.nextSibling);

                // Add drag functionality
                let isResizing = false;
                let startY = 0;
                let startHeight = 0;

                handle.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    startHeight = container.offsetHeight;

                    // Prevent text selection while dragging
                    e.preventDefault();
                    document.body.style.userSelect = 'none';
                    document.body.style.cursor = 'ns-resize';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!isResizing) return;

                    const deltaY = e.clientY - startY;
                    const newHeight = Math.max(200, Math.min(1200, startHeight + deltaY));

                    container.style.maxHeight = newHeight + 'px';
                    container.style.height = newHeight + 'px';
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.userSelect = '';
                        document.body.style.cursor = '';
                    }
                });
            });
        });

    </script>
</body>
</html>

